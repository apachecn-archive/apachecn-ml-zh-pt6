<html><head/><body>





<style type="text/css">body{margin:1em;background-color:transparent!important;}#sbo-rt-content *{text-indent:0pt!important;}#sbo-rt-content .bq{margin-right:1em!important;}#sbo-rt-content *{word-wrap:break-word!important;word-break:break-word!important;}#sbo-rt-content table,#sbo-rt-content pre{overflow-x:unset!important;overflow:unset!important;overflow-y:unset!important;white-space:pre-wrap!important;}</style>
<div><div><h1 id="_idParaDest-178"><em class="italic"> <a id="_idTextAnchor182"/>第九章</em>:舰队规模化管理</h1>
			<p><strong class="bold">物联网</strong> ( <strong class="bold">物联网</strong>)在 1999 年宝洁公司有一个不起眼的开端，当时凯文·阿什顿提出了将<strong class="bold">射频识别</strong> ( <strong class="bold"> RFID </strong>)天线集成到口红货架上的想法，以使分店经理能够更好地跟踪化妆品库存，进行补货。从那时起，这种技术以某种形式被所有行业采用，并在当今世界变得无处不在。</p>
			<p>管理已知物理边界内的一组 RFID 标签、传感器和致动器是相对容易的任务。然而，在这些设备的整个生命周期中管理全球数百万(或数十亿或数万亿)的设备却并非如此。尤其是当这些设备分布在不同的位置，具有不同形式的连接和接口时。</p>
			<p>因此，在本章中，您将了解通过 AWS 本机服务远程登录、维护和诊断设备群的最佳实践。此外，您还将获得构建运营中心的实践经验，以评估联网车队的健康状况，从而采取必要的行动。</p>
			<p>在本章中，我们将讨论以下主题:</p>
			<ul>
				<li>在全球范围内部署一批设备</li>
				<li>大规模管理您的车队</li>
				<li>构建运营中心的实践练习</li>
				<li>检查你的知识</li>
			</ul>
			<h1 id="_idParaDest-179"><a id="_idTextAnchor183"/>技术要求</h1>
			<p>本章的技术要求与<a href="B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032"> <em class="italic">第二章</em> </a> <em class="italic">【边缘工作负载基础】中概述的技术要求相同。请参阅该章中的完整要求。</em></p>
			<h1 id="_idParaDest-180"><a id="_idTextAnchor184"/>在全球范围内部署一系列设备</h1>
			<p>我们已经在<a href="B17595_08_Final_SS_ePub.xhtml#_idTextAnchor163"> <em class="italic">第 8 章</em></a><em class="italic">devo PS 和 mlop for the Edge</em>中<a id="_idIndexMarker836"/>向您介绍了物联网制造供应链中涉及的不同活动。<strong class="bold"> Onboarding </strong>是指制造、组装设备并向注册机构注册的过程。在本节中，我们将深入探讨在入职工作流程中起作用的以下活动:</p>
			<div><div><img src="img/Table_09_01.jpg" alt="Figure 9.1 – Device onboarding activities&#13;&#10;" width="1116" height="281"/>
				</div>
			</div>
			<p class="figure-caption">图 9.1–设备上线活动</p>
			<p>到目前为止，在这本书里，你一直在使用一个<strong class="bold">树莓派</strong>(或者一个虚拟环境)来进行动手练习。这是开发和原型需求的常见实践。但是，随着您的项目向更高的环境(比如 QA 或生产)发展，建议您考虑工业级的、可以在各种条件下运行的硬件。因此，<em class="italic">图 9.1 </em>中的所有上述活动需要在您的设备(即连接的 HBS 中枢)可以通过您的分销渠道在不同的零售店销售之前完成(并热销！).</p>
			<p>在本章的剩余部分，我们假设您的公司已经与您的首选供应商建立了明确的供应链，并且设备制造工作流程可以组装设备。当您的客户打开这些设备的包装时(太激动了！)并开始设置过程，设备需要本地引导(在边缘)并成功向<strong class="bold"> AWS IoT </strong>服务注册，以完全投入运行。</p>
			<p>所以，你一定在想，要使设备注册成功，需要预先执行哪些必要步骤？它来了。</p>
			<h2 id="_idParaDest-181"><a id="_idTextAnchor185"/>注册证书颁发机构</h2>
			<p>有<a id="_idIndexMarker838"/>种不同类型的<em class="italic">密码</em>凭证<a id="_idIndexMarker839"/>，如用户 ID、密码、出售的<a id="_idIndexMarker840"/>令牌(如<a id="_idIndexMarker841"/>如<strong class="bold"> JWT </strong>和<strong class="bold"> OAuth </strong>)，以及物联网设备可以使用的对称或非对称密钥。我们建议使用非对称密钥，因为在撰写本文时，这被认为是业内最安全的方法。在之前的所有实践练习中，您利用了由 AWS IoT <strong class="bold">认证机构</strong> ( <strong class="bold"> CA </strong>)生成的<strong class="bold">非对称 X.509 </strong>密钥和证书，它们嵌入在运行 Greengrass 的 HBS 连接中心中。CA 是一个受信任的实体，它颁发加密凭证，如数字密钥和证书。这些凭证在云上注册并嵌入到设备中，以实现传输层安全性或基于 TLS 的相互身份验证。具体来说，有四种数字资源与相互 TLS 认证工作流相关联，如下所示:</p>
			<ul>
				<li><strong class="bold"> X.509 证书</strong>:这是一个<a id="_idIndexMarker842"/>证书，要求在设备和云中都存在，并且在相互 TLS 握手期间存在。</li>
				<li><strong class="bold">私钥和公钥</strong>:使用<a id="_idIndexMarker843"/>算法<a id="_idIndexMarker844"/>生成的非对称密钥对，如<strong class="bold">Rivest-sha mir-ad leman</strong>(<strong class="bold">RSA</strong>)或<strong class="bold">椭圆曲线密码</strong> ( <strong class="bold"> ECC </strong>)。作为最佳实践，私钥只保留在设备上，应该受到保护以避免身份泄露。</li>
				<li><strong class="bold">签名者 CA </strong>:这是一个由 AWS 和 Verisign 等可信 CA 颁发和签名的根证书或中间证书。在注册过程中，设备需要将此颁发 CA 与客户端证书一起发送。如果签名者 CA 不可用，也可以发送 TLS 相互认证的<strong class="bold">服务器名称指示</strong> ( <strong class="bold"> SNI </strong>)部分<a id="_idIndexMarker845"/>来验证信任。</li>
				<li><strong class="bold">服务器证书</strong>:这是一个证书，设备使用 TLS 握手过程中提供的证书链<a id="_idIndexMarker846"/>来验证它没有与模拟服务器通信。</li>
			</ul>
			<p>下图显示了工作流程以及这些数字资源在<a id="_idIndexMarker847"/>设备<a id="_idIndexMarker848"/>和云中的位置:</p>
			<div><div><img src="img/Figure_09_02.jpg" alt="Figure 9.2 – Cryptographic credentials within an IoT workflow&#13;&#10;" width="1650" height="708"/>
				</div>
			</div>
			<p class="figure-caption">图 9.2–物联网工作流程中的加密凭证</p>
			<p>因此，在设计过程中尽早确定 CA 非常重要。这使得它可以发布设备所需的前述数字资源，以执行向后端机构的注册，并变得完全可操作。有三种不同的方式可以将 CA 与 AWS IoT Core 配合使用，如下表所示，并列出优缺点:</p>
			<div><div><img src="img/B17595_09_03.jpg" alt="Figure 9.3 – Choosing a CA&#13;&#10;" width="1026" height="477"/>
				</div>
			</div>
			<p class="figure-caption">图 9.3–选择 CA</p>
			<p>CA 设置完成后，下一步是根据场景选择设备供应方法<a id="_idIndexMarker849"/>。接下来让我们更详细地了解一下<a id="_idIndexMarker850"/>。</p>
			<h2 id="_idParaDest-182"><a id="_idTextAnchor186"/>决定供应方式</h2>
			<p>在物联网世界的许多上下文中，供应和注册等术语可以互换使用，但我们认为它们之间有明显的区别。对我们来说，设备配置是两项活动的融合，即设备注册和设备激活。<em class="italic">设备注册</em>是一个过程，其中设备使用其初始加密凭证向注册机构(如 AWS 物联网身份服务)成功认证，报告独特的属性，如型号和序列号，并在设备注册表中作为唯一身份进行关联。此外，授权机构可以返回一组新的证书，设备可以用先前的证书替换该组新的证书。在此之后，特权自动扶梯可以增强相关主体(例如 X.509 证书)的特权，以使设备被激活并完全可操作。</p>
			<p>这些供应步骤有不同的方法，这些方法通常来源于一个组织在制造供应链中希望拥有的控制或便利程度。通常，这种选择由几个因素决定，如内部技能、成本、安全性、上市时间或对产品知识产权的敏感性。您在<a href="B17595_02_Final_SS_ePub.xhtml#_idTextAnchor032"> <em class="italic">第 2 章</em> </a>、<em class="italic">边缘工作负载基础</em>中了解了通过物联网设备测试器进行自动配置的方法，这在原型开发和实验中非常普遍。</p>
			<p>在本节中，我们将讨论两种生产级配置方法，通过从以下场景向后工作，它们可以从一台<a id="_idIndexMarker852"/>设备扩展到数百万台(或更多)设备。</p>
			<h3>场景 1–批量供应具有独特固件映像的 HBS 集线器</h3>
			<p>在这种情况下，您<a id="_idIndexMarker853"/>可以使用包含唯一加密凭证的唯一固件映像，在您的供应链中批量供应 HBS 枢纽车队:</p>
			<ol>
				<li>作为 HBS 中心的设备制造商，首先，您将使用受支持的 API 将您选择的 CA 与 AWS 物联网核心相关联。该 CA 将管理信任链，并为整个设备群创建和验证加密凭证(如证书或证书签名请求)。</li>
				<li>然后，您将创建一个配置模板，它本质上是一个配置文件，包含 AWS 物联网身份服务为 HBS 中心设备创建一个事物(或虚拟表示)的指令。该模板<a id="_idIndexMarker854"/>将包括不同的输入参数，例如<code>ThingName</code>、<code>SerialNumber</code>和<strong class="bold">证书签名请求</strong>(<strong class="bold">CSR</strong>)，这将导致创建物联网资源，例如虚拟事物、设备元数据、证书和策略。可以参考官方<em class="italic">物联网 on AWS </em>博客上显示的模板，标题为<em class="italic">使用 AWS 物联网设备管理服务轻松部署车队</em>(<a href="https://aws.amazon.com/blogs/iot/deploy-fleets-easily-with-aws-iot-device-management-services/">https://AWS . Amazon . com/blogs/IoT/Deploy-Fleets-easy-with-AWS-IoT-Device-Management-Services/</a>)。该模板可在<em class="italic">创建供应模板</em>部分找到。</li>
				<li>下一步是通过首选工具<a id="_idIndexMarker855"/>链(如<strong class="bold"> OpenSSL </strong>)生成加密凭证，如私钥和 CSR。接下来，创建一个包含设备和加密凭证列表的输入文件，该文件将被提供给配置模板。输入文件最简单的形式可能是这样的:<pre>{"ThingName": "hbshub-one", "SerialNumber": "0001", "CSR": "*** CSR FILE CONTENT ***"} {"ThingName": "hbshub-two", "SerialNumber": "0002", "CSR": "*** CSR FILE CONTENT ***"} {"ThingName": "hbshub-three", "SerialNumber": "0003", "CSR": "*** CSR FILE CONTENT ***"}</pre></li>
				<li>现在，调用 API 来创建所有这些虚拟设备(即事物)的时机已经到来，这些虚拟设备(即事物)是以<a id="_idIndexMarker856"/>批量的方式在云上的物联网设备注册表中创建的，同时还有由 CA 签名的其各自的加密凭证(如证书或 CSR)。一旦这个步骤完成，就需要创建一个令牌交换角色，并且这些东西需要与特定于 Greengrass 的构造相关联，比如一个 Greengrass 核心、一个事物组和一个安装过程所需的配置文件(<code>config.yaml</code>)。</li>
				<li>接下来，您将把前面步骤中生成的证书注入到您的固件中，这些证书包括来自<em class="italic">步骤 3 </em>的私钥和来自<em class="italic">步骤 4 </em>的签名证书。这个更新的固件，通常被称为黄金映像，然后与您的组装团队(内部或合同制造商)共享。组装团队会将此图像闪现在制造流程的设备部分:</li>
			</ol>
			<div><div><img src="img/Figure_09_04.jpg" alt="Figure 9.4 – Bulk provisioning with embedded credentials&#13;&#10;" width="984" height="641"/>
				</div>
			</div>
			<p class="figure-caption">图 9.4–使用嵌入式凭据进行批量供应</p>
			<p>这种方法在运行 RTOS 的微控制器中很常见，因为这些硬件还不支持增量更新。然而，对于连接的 HBS 中心，将固件映像从加密凭证中分离出来会更灵活，操作效率更高。</p>
			<p>这就是第二种选择的来源。在这里，您将仍然以与上一步相同的方式从 CA 生成东西和惟一凭证，但是您不会将它注入到固件中。相反，你将开发一个智能的<a id="_idIndexMarker858"/>固件，它能够<a id="_idIndexMarker859"/>通过不同的接口接受凭证<a id="_idIndexMarker860"/>，比如<strong class="bold">安全外壳</strong>(<strong class="bold">SSH</strong>)<strong class="bold">网络文件系统</strong> ( <strong class="bold"> NFS </strong>)，或者<strong class="bold">串行连接</strong>。作为最佳实践，通常将凭证存储在单独的芯片中，例如安全的<a id="_idIndexMarker861"/>元件或<strong class="bold">可信平台模块</strong> ( <strong class="bold"> TPM </strong>)。此外，固件可以使用公钥密码标准接口(如<em class="italic"> PKCS#11 </em>)来实时检索固件或其他本地应用程序所需的密钥和证书。在撰写本书时，Greengrass v2 正在等待对 TPM 的支持，尽管它是 Greengrass v1 中受支持的功能:</p>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_09_05.jpg" alt="Figure 9.5 – Bulk provisioning with the injection interface&#13;&#10;" width="1204" height="395"/>
				</div>
			</div>
			<p class="figure-caption">图 9.5–使用注入界面进行批量供应</p>
			<p>让我们看看如何着手第二个选择:</p>
			<ol>
				<li value="1">一旦设备组装完成，包含必要配置和凭证的黄金映像，产品就通过不同的分销渠道到达客户手中。当客户打开设备，设备第一次唤醒时，引导过程开始。</li>
				<li>自举将实例化各种本地进程(或<em class="italic">守护进程</em>)，即固件指令。其中一个过程包括向 AWS 物联网身份服务注册，设备将连接到云端点并交换 TLS 相互身份认证的嵌入式凭据部分。考虑到作为组装的先决条件，事物、证书和策略已经被创建，如果相互认证成功，则设备完全可操作。</li>
			</ol>
			<h3>场景 2–及时提供共享索赔的 HBS 中心</h3>
			<p>让我们考虑下面的场景；您的设备可能无法在制造时接受唯一的凭据。或者，贵组织承担在供应链的每个 HBS 中心嵌入唯一凭证的运营开销，成本过高。这是另一种模式出现的地方，称为通过声明的设备群供应，作为设备制造商，您可以在您的设备群中嵌入非唯一的共享凭据(称为声明)。然而，我们建议您不要对整个舰队共享相同的声明，而是只共享一部分，以在任何安全问题的情况下减少爆炸半径。看看下面的步骤:</p>
			<ol>
				<li value="1">作为第一步，合同制造商在设备上加载固件以及机群供应插件和共享证书(即声明),而不执行任何定制。按声明配置设备群的方法使用模板化的方法来配置所需的云资源，该方法类似于前面的场景。您可以参考 AWS 文档中提供的一个示例模板，名为<em class="italic">为 Greengrass 核心设备设置 AWS 物联网车队供应</em>(<a href="https://docs.aws.amazon.com/greengrass/v2/developerguide/fleet-provisioning-setup.html#create-provisioning-template">https://docs . AWS . Amazon . com/green grass/v2/developer guide/fleet-provisioning-setup . html # create-provisioning-template</a>)。主要区别在于，所有这些资源都是及时提供的，每个设备都从其当前位置启动引导过程，而不是在制造工厂中批量映像。</li>
				<li>This approach also supports a pre-provisioning hook feature in which a lambda function can be <a id="_idIndexMarker863"/>invoked to validate different parameters or perform pre-provisioning logic. For example, it can be as simple as overriding a parameter to more complex validations such as checking whether the claim certificate is part of a revocation list:<pre>def pre_provisioning_hook(event, context):
    return {
        'allowProvisioning': True,
        'parameterOverrides': {
            'DeviceLocation': 'NewYork'
        }
        }</pre><p>在这里，当集线器唤醒并第一次连接到 AWS IoT 时，声明证书被交换为由 CA (AWS 或 BYO)签名的永久 X.509 凭证。这就是车队供应插件的帮助之处，因为它允许设备发布和订阅所需的<strong class="bold"> MQ 遥测传输</strong> ( <strong class="bold"> mqtt </strong>)主题，接受唯一的凭证，并且<a id="_idIndexMarker864"/>保存在安全类型的存储中:</p><div><img src="img/Figure_09_06.jpg" alt="Figure 9.6 – Fleet provisioning with shared claims&#13;&#10;" width="1650" height="1379"/></div><p class="figure-caption">图 9.6–共享索赔的车队供应</p></li>
				<li>Following<a id="_idIndexMarker865"/> this, the device must also disconnect from the previous session it initiated with the shared claim and reconnect with the unique credentials.<p class="callout-heading">一句警告</p><p class="callout">如果共享的索赔没有通过供应渠道得到保护，则按索赔供应车队会带来安全风险。</p></li>
			</ol>
			<p>设备调配完成后，下一步是对其进行组织，以简化整个生命周期中的管理。Greengrass 核心设备可以组织成事物组，这是在 AWS 物联网生态系统中组织设备群的结构。一个<strong class="bold">事物群</strong><a id="_idIndexMarker866"/>本质上可以是静态的，也可以是动态的。顾名思义，静态组允许根据不变的属性(如产品类型、制造商、序列号、生产日期等)来组织设备。</p>
			<p>此外，静态组允许构建具有父设备和子设备的设备层次结构，该层次结构可以跨越多达七层。例如，查询属于 XYZ 公司的序列号范围内的一组洗衣机传感器，可以有助于识别由于生产缺陷而需要召回的设备。</p>
			<p>相比之下，动态组是使用连接状态、注册表元数据或设备映像等索引信息创建的。因此，动态组的成员总是在变化。这就是动态组不与任何设备层次结构相关联的原因；例如，查询在某个时间点连接且固件版本为 v1 的一组 HBS 设备。该结果可以允许车队运营商向各个所有者推送固件更新通知。</p>
			<p>使用事物组的另一个优势<a id="_idIndexMarker867"/>是能够在设备组级别分配设备组权限(即策略)，然后级联到该层次结构中的所有设备。这减轻了在每个设备级别管理策略的开销。同时，尽管有可能制定特定于设备的策略，但 AWS 物联网身份服务将在身份验证和授权工作流程中自动评估组和设备级别之间允许的最低特权访问级别。</p>
			<p>现在，您已经很好地理解了如何使用不同的方法来配置和组织 HBS 中心。接下来，我们来讨论一下一旦车队铺开后如何管理。</p>
			<h1 id="_idParaDest-183"><a id="_idTextAnchor187"/>大规模管理您的设备</h1>
			<p>尽管监控少量设备可能会更容易，但管理大量设备可能会成为一场运营噩梦。为什么？这是因为物联网设备(如 HBS 枢纽)不仅仅部署在受控的边界(如数据中心)。您现在应该已经了解到，这些设备可以部署在任何地方，例如家庭、办公室、商业场所，这些地方可能具有不同的用电、网络连接和安全状况。例如，有时设备会离线运行，并且由于该场所的 WI-FI 连接间歇性不可用而无法通过公共或私有网络使用。因此，作为一名物联网专业人员，您必须考虑各种情况，并提前计划如何大规模管理您的车队。</p>
			<p>在互联 HBS 枢纽的环境中，设备管理可以帮助您实现以下目标:</p>
			<ul>
				<li>从现实世界中获取可操作的信息。</li>
				<li>通过尽早捕获异常来提高解决方案的效率。</li>
				<li>使用预测性或预防性维护优化成本。</li>
				<li>防止窃取知识产权或未经授权的访问。</li>
				<li>建立一个持续的反馈循环来改善客户体验。</li>
				<li>通过更多数据洞察创造更多收入流。</li>
			</ul>
			<p>因此，正如您可能已经意识到的那样，开发物联网解决方案并将其推广给客户仅仅是个开始。有必要管理解决方案的整个生命周期，以实现前面提到的业务成果。因此，设备管理也可以被视为以下活动的大保护伞:</p>
			<ul>
				<li>规定</li>
				<li>组织</li>
				<li>班长</li>
				<li>维持</li>
				<li>诊断</li>
			</ul>
			<p>下图显示了物联网设备管理工作流程:</p>
			<div><div><img src="img/Figure_09_07.jpg" alt="Figure 9.7 – The IoT Device Management workflow&#13;&#10;" width="1604" height="369"/>
				</div>
			</div>
			<p class="figure-caption">图 9.7–物联网设备管理工作流程</p>
			<p>我们已经在 Greengrass 的上下文中讨论了上一节中的前三个主题。因此，我们将继续关注剩余的活动。</p>
			<h2 id="_idParaDest-184"><a id="_idTextAnchor188"/>监视器</h2>
			<p>监控支持 Greengrass 的<a id="_idIndexMarker870"/>HBS 中心和相关的<a id="_idIndexMarker871"/>设备将是实现可靠、高可用性和高性能物联网工作负载的关键。您应该有一种从边缘解决方案收集监控数据的机制，以便在出现故障时进行调试。Greengrass 支持收集<em class="italic">系统健康遥测</em>和<em class="italic">自定义指标</em>，它们是诊断数据点，用于监控 Greengrass 核心设备上不同组件和应用的关键操作性能。下面列出了收集这些数据的不同方法:</p>
			<ul>
				<li>即使到云的连接时断时续，您也可以在本地对核心设备上的数据进行操作。</li><li>可选地，该组件可以被配置为将遥测数据发布到云中的<em class="italic"> mqtt </em>主题。</li><li>这是一个连续的系统遥测数据流，以近乎实时的方式发布到本地主题。默认配置是每 60 秒一次。</li><li>如果遥测数据在本地发布，是没有成本的，但是当它被推送到云端时，就要收费。</li></ul>
				<li><strong class="bold">遥测代理</strong>是另一个<a id="_idIndexMarker873"/>选项，您可以使用它来收集本地遥测数据，默认情况下，所有 Greengrass 核心设备都启用该选项:<ul><li>该代理收集遥测数据，并通过<strong class="bold"> Amazon EventBridge </strong>尽最大努力将其发布到云，这是一种无服务器事件总线服务。</li><li>一旦 Greengrass 核心设备启动并运行，数据就开始流动。默认情况下，遥测代理每小时汇总一次遥测数据，每 24 小时发布一次到云中。</li><li>由于消息是发布到 AWS 物联网核心上的保留主题，因此<a id="_idIndexMarker874"/>没有数据传输费用。</li></ul></li>
				<li>A <em class="italic">telemetry agent</em> publishes the following metrics natively: <ul><li>系统内存和 CPU 利用率</li><li>文件描述符的总数，其中每个描述符代表一个打开的文件</li><li>各种状态下的组件数量，如下所示:<ul><li>已安装、新安装和启动</li><li>运行、停止和结束</li><li>出错、损坏和无状态</li></ul></li></ul><p>稍后，在实践部分，您将收集这些指标并在云上处理它们。</p></li>
				<li><em class="italic"> CloudWatch metrics </em>是一个 Greengrass 组件，允许您将自定义指标发布到亚马逊 CloudWatch:<ul><li>部署在核心设备上的任何定制组件(如 lambda 函数或容器)都可以将定制指标发布到本地主题(<code>cloudwatch</code> / <code>metric</code> / <code>put</code>)。</li><li>这些组件可以被配置为指定不同的发布时间间隔(以秒为单位)，因此可以使用或不使用批处理来发布指标。例如，对于 lambda，默认的批处理窗口是 10 秒，最大等待时间可能是 900 秒。</li><li>因此，如果您想到必须从与集线器相关联的传感器和执行器收集指标，而不仅仅是从网关收集指标的场景，那么自定义应用程序可以检索这些数据点，并将它们发布到本地或云端点，以便进行监控。</li></ul></li>
				<li><em class="italic">日志管理器</em>是一个 Greengrass 组件，可以部署到您的 Greengrass 核心设备上，以收集日志，并可选择将日志上传到 Amazon CloudWatch 日志:<ul><li>虽然<a id="_idIndexMarker876"/>指标<a id="_idIndexMarker877"/>有助于反映设备的状态，但日志对于排除异常或故障至关重要。</li><li>为了实时观察日志，Greengrass 提供了各种日志文件。其中一些您现在可能已经使用过了，例如:<ul><li><strong class="bold"> Greengrass.log </strong>:这是一个日志文件，用于查看关于 nucleus 和组件部署的实时信息。例如，对于 HBS 中心，该日志文件可以报告 nucleus 软件的错误、异常和故障，您(或客户)可以分析这些错误、异常和故障。</li><li><strong class="bold"> Component.log </strong>:这是一个日志文件，用于查看核心设备上运行的组件的实时信息。</li><li><strong class="bold"> Main.log </strong>:这是一个处理组件生命周期信息的日志文件。</li></ul></li><li>日志管理器组件可以以各种频率上传日志。日志管理器的默认配置是每 5 分钟向 AWS CloudWatch 上传一次新日志。此外，可以为更频繁的上传配置更低的上传间隔。日志格式也可以在文本格式和 JSON 格式之间进行配置。</li><li>日志管理器还支持每小时或超过文件大小限制时进行文件循环。日志文件的默认大小限制是 1 MB，磁盘大小是 10 MB，并且完全可以配置。为了优化日志大小，对不同的环境(如开发、测试和生产)使用不同的详细级别也是一种最佳实践:<ul><li>例如，您可以选择调试级日志来帮助排除非生产环境中的故障，或者选择错误级日志来减少设备在生产环境中生成的日志数量。这种选择也有助于优化成本。</li></ul></li></ul></li>
			
			<p>当您从 HBS 中心收集所有这些数据点(指标和日志)并将它们发布到云时，下一步是允许不同的角色，如车队运营商(或其他下游企业)消费这些信息。这可以通过 CloudWatch 来实现，cloud watch 本身提供了各种与日志洞察、生成仪表板、设置警报等相关的功能。如果您的组织已经标准化了监控解决方案(如<strong class="bold"> Splunk </strong>、<strong class="bold"> Sumologic </strong>、<strong class="bold"> Datadog </strong>或其他)，CloudWatch 也支持这种集成。</p>
			<p>最后，在控制平面中，Greengrass 与<strong class="bold"> AWS CloudTrail </strong>集成，以记录与服务 API、IAM 用户和角色相关的访问事件<a id="_idIndexMarker878"/>。这些访问日志可<a id="_idIndexMarker879"/>用于确定有关 Greengrass 访问的其他详细信息，例如发出请求的 IP 地址、发出请求的人以及发出请求的时间，这对于各种安全和运营需求非常有用。</p>
			<h2 id="_idParaDest-185"><a id="_idTextAnchor189"/>维护</h2>
			<p>之前<a id="_idIndexMarker880"/>解释的服务，如亚马逊 CloudWatch(或第三方解决方案)，可以足够强大，以生成监控物联网工作负载健康状况所需的各种见解。然而，物联网管理员或车队运营商的另一个常见问题是拥有单一控制台视图，使他们能够从设备车队中获取一组全面的信息，以快速排查运营事件。</p>
			<p>例如，考虑这样一个场景，客户抱怨他们的 HBS 中心出现故障。作为车队操作员，您可以从仪表板上观察到大量连接中断和高资源利用率。因此，您查找日志(在设备上或云中)，并确定这是由于特定组件(如<em class="italic">聚合器</em>)导致的内存泄漏问题。根据您的操作手册，您需要确定这是一次性问题，还是设备群中的更多设备出现类似行为。因此，您需要一个界面来搜索、识别和可视化设备状态、设备连接、整个设备群的电池电量等指标，或者按用户位置过滤的指标。这就需要一个车队管理解决方案，比如<strong class="bold"> AWS 车队中心</strong>，它<a id="_idIndexMarker881"/>允许创建一个完全托管的 web 应用程序，以满足使用无代码方法的各种角色。在我们的场景中，这个 web 应用程序可以帮助运营商近乎实时地查看、查询和与一组相连的 HBS 枢纽进行交互，并进一步解决问题。除了监控之外，操作员还可以对警报做出响应，并通过无线 ( <strong class="bold"> OTA </strong>)触发远程操作<strong class="bold">以从单一界面<a id="_idIndexMarker882"/>修复部署的设备。AWS 车队枢纽应用程序还<a id="_idIndexMarker883"/>支持以下功能:</strong></p>
			<ul>
				<li><em class="italic">与现有身份和访问管理系统(如 Active Directory 和 LDAP)集成</em>,允许对不同角色进行基于角色的访问，如车队运营商、车队经理、设备制造商、第三方以及以某种方式与 HBS 中心互动的 IT 运营商。此外，这允许这些用户<a id="_idIndexMarker884"/>使用<strong class="bold">单点登录</strong> ( <strong class="bold"> SSO </strong>)并从台式机、平板电脑或智能手机上的任何浏览器访问车队中心。</li>
				<li><em class="italic">来自 AWS 物联网车队索引、亚马逊<a id="_idIndexMarker885"/> CloudWatch 或<strong class="bold">亚马逊简单通知服务</strong> ( <strong class="bold"> SNS </strong>)等其他服务的数据聚合</em>。物联网设备索引服务有助于索引、搜索、查询和聚合来自设备注册表、设备影子和设备连接事件的数据。此外，还可以创建自定义字段。CloudWatch 指标可以与这些可搜索字段结合使用来创建警报。最后，当警报阈值被突破时，Amazon SNS 可以通知不同的角色。</li>
			</ul>
			<p>总之，Fleet Hub 的这些功能可以让组织更快地响应<a id="_idIndexMarker886"/>不同的运营事件，从而改善客户体验。</p>
			<h2 id="_idParaDest-186"><a id="_idTextAnchor190"/>诊断</h2>
			<p>在前面的<a id="_idIndexMarker887"/>场景中，您了解了车队操作员如何通过单一控制台视图近乎实时地了解运营事件。但是，如果通过 Fleet Hub 进行的远程操作不足以修复已发现的问题，那么进一步诊断该问题会怎么样呢？例如，一个操作员可能触发了一个远程操作来重启聚合器组件或 HBS 中心本身，但这并没有为最终用户解决问题。因此，作为下一步，操作员需要直接接触轮毂或相关传感器，以便进一步排除故障。传统上，在这种情况下，公司会安排与技术人员的预约，这意味着客户需要额外的成本和等待时间。这就是像<strong class="bold"> AWS 物联网安全隧道</strong>这样的远程诊断功能有用的地方。这是一项 AWS 托管服务，允许车队运营商通过到目标设备的安全隧道获得额外权限(如 SSH 或 RDP 访问)。</p>
			<p>Greengrass 的安全隧道组件支持操作员工作站和支持 Greengrass 的设备(如 HBS 中心)之间的安全双向通信，即使它位于受限防火墙之后。这是可能的，因为远程操作通过引擎盖下的安全隧道导航。此外，设备还将继续使用遥测中用于该远程操作的相同加密证书(即，<em class="italic"> X509 证书</em>)。客户端<a id="_idIndexMarker888"/>唯一的其他依赖(即<strong class="bold">车队运营商</strong>)是在笔记本电脑或网络浏览器上安装代理软件。这是因为这个代理软件通过允许在会话启动时与隧道服务交换临时凭证(即<strong class="bold">访问令牌</strong>)来实现这一奇迹。下图显示了安全隧道的工作流程:</p>
			<div><div><img src="img/Figure_09_08.jpg" alt="Figure 9.8 – The secure tunneling workflow for diagnostics&#13;&#10;" width="1325" height="504"/>
				</div>
			</div>
			<p class="figure-caption">图 9.8–诊断的安全隧道工作流程</p>
			<p>对于我们的场景，源是指车队运营商的工作站，目的地是指连接的 HBS 中心，安全隧道服务由 AWS 管理。</p>
			<p>现在，您已经很好地了解了如何更好地监控、维护和诊断<a id="_idIndexMarker889"/>边缘设备，让我们在本章的最后一节动手实践一下。</p>
			<h1 id="_idParaDest-187"><a id="_idTextAnchor191"/>亲身体验车队枢纽架构</h1>
			<p>在本<a id="_idIndexMarker890"/>部分，您将了解如何使用 nucleus emitter 和遥测代理从边缘设备捕获各种指标和日志，并通过 Amazon CloudWatch 和 AWS IoT Fleet Hub 对其进行可视化。以下是展示您将在实验中完成的不同服务和步骤的体系结构:</p>
			<div><div><img src="img/Figure_09_09.jpg" alt="Figure 9.9 – Hands-on operational hub&#13;&#10;" width="1650" height="615"/>
				</div>
			</div>
			<p class="figure-caption">图 9.9–实际操作中心</p>
			<p>下表<a id="_idIndexMarker891"/>列出了您将在本练习中使用的服务:</p>
			<div><div><img src="img/Table_09_10.jpg" alt="Figure 9.10 – The services in scope for this exercise&#13;&#10;" width="1146" height="431"/>
				</div>
			</div>
			<p class="figure-caption">图 9.10-本练习范围内的服务</p>
			<p>如前面的体系结构所述，您在实践部分的目标包括以下步骤:</p>
			<ol>
				<li value="1">使用 AWS 物联网车队中心构建运营仪表板。</li>
				<li>部署 nucleus 发射器组件，并从边缘通过遥测技术收集指标。</li>
				<li>部署一个日志管理器组件，并将日志流式传输到 Cloudwatch。</li>
				<li>在物联网 Fleet Hub 和 CloudWatch 上可视化结果。</li>
			</ol>
			<p>接下来，让我们更详细地看一下前面的步骤。</p>
			<h2 id="_idParaDest-188"><a id="_idTextAnchor192"/>构建云资源</h2>
			<p>在本节中，您<a id="_idIndexMarker893"/>将学习如何设置一个 Fleet Hub 应用程序，该应用程序可用于监控来自已连接的 HBS 中心的指标。执行以下步骤:</p>
			<ol>
				<li value="1">导航至<strong class="bold"> AWS 物联网核心控制台</strong>并选择<strong class="bold">车队枢纽</strong>。选择<strong class="bold">开始</strong>并点击<strong class="bold">创建应用</strong>。</li>
				<li>这将提示您使用 AWS SSO 设置<strong class="bold">单点登录</strong>。如果您过去没有使用过此服务，请使用必要的信息创建一个用户。您将通过电子邮件收到一份邀请，您需要接受该邀请以及如何设置密码的说明。点击<strong class="bold">下一个</strong>。</li>
				<li>现在您需要配置 AWS 物联网数据的索引。如前所述，Fleet Hub 通过聚合来自不同来源的信息，为您提供了单一控制台视图。这是您设置所有这些集成的地方。</li>
				<li>点击<strong class="bold">车队索引</strong>部分的<strong class="bold">管理索引</strong>。这将打开 AWS 物联网设置页面。再次点击<strong class="bold">管理索引</strong>，启用所有可用选项，如<strong class="bold">事物索引</strong>和<strong class="bold">事物组索引</strong>。或者，如果愿意，您也可以创建自定义搜索字段。点击<strong class="bold">更新</strong>。</li>
				<li>导航回车队中心设置屏幕，设置现在应该处于活动状态。点击下一个的<strong class="bold">。</strong></li>
				<li>使用您选择的名称创建应用程序角色和应用程序。单击查看策略权限，了解提供给应用程序的访问权限。您应该注意到，正如前面提到的，您正在为 Fleet Hub 提供对物联网、CloudWatch 和 SNS 资源的访问，以便与所有这些资源集成。点击<strong class="bold">创建应用</strong>。</li>
				<li>在 Fleet Hub 的<strong class="bold">应用</strong>选项卡上，点击显示为活动的应用 URL。对于第一次访问，这将提示您添加一个 SSO 用户。单击它并添加您之前创建的用户。点击<strong class="bold">添加选定用户</strong>。</li>
				<li>完成后，再次点击应用程序 URL，进入 web 仪表板，使用您在<em class="italic">步骤 2 </em>中配置的凭证登录。单击应用程序图标，它应该会为您打开仪表板。</li>
			</ol>
			<p>恭喜你！你<a id="_idIndexMarker894"/>都设置好了舰队枢纽仪表盘！</p>
			<p class="callout-heading">注意</p>
			<p class="callout">虽然我们在本实验中只创建了一个用户，但是您可以将 AWS SSO 与您组织的身份管理系统(如 Active Directory)集成。这将允许不同角色基于角色访问仪表板。理想情况下，这种配置将属于身份工程师的权限范围，而不是物联网专业人员的责任。</p>
			<p>接下来，让我们设置将遥测数据从 HBS 中心接收到云的路由规则:</p>
			<ol>
				<li value="1">导航到<strong class="bold">亚马逊事件桥</strong>控制台(<a href="https://go.aws/3xcB2T7">https://go.aws/3xcB2T7</a>，点击<strong class="bold">创建规则</strong>。</li>
				<li>选择规则的名称和描述。</li>
				<li>在<code>AWS</code>中。</li><li>服务名称:<code>Greengrass</code>。</li><li>事件类型:<code>Greengrass Telemetry Data</code>。</li>
				<li>保持<strong class="bold">选择事件总线</strong>部分的默认设置。</li>
				<li>在<code>/aws/events/</code> &lt;下，将其替换为您选择的名称&gt;</li>
				<li>将其他一切保持默认设置，并点击<strong class="bold">创建</strong>。</li>
			</ol>
			<p>干得好！EventBridge 已经准备好接收遥测数据并将其发布到 CloudWatch 组。</p>
			<p>我们将在实验结束时再次查看这些仪表板，以可视化从<a id="_idIndexMarker895"/>中心收集的数据。现在，让我们在 Greengrass 上配置和部署 edge 连接器。</p>
			<h2 id="_idParaDest-189"><a id="_idTextAnchor193"/>将组件从云部署到边缘</h2>
			<p>在本节<a id="_idIndexMarker896"/>中，您将学习如何将<strong class="bold"> Nucleus Emitter </strong>和<strong class="bold"> Log Manager </strong>代理部署到支持 Greengrass 的 HBS 中心，以将健康遥测发布到云。执行以下步骤:</p>
			<ol>
				<li value="1">请导航到亚马逊 Greengrass 控制台，选择<code>aws.greengrass.telemetry.NucleusEmitter</code>和<code>aws.greengrass.LogManager</code>组件。随意点击<strong class="bold">查看配方</strong>查看该组件的配置。</li>
				<li>点击<strong class="bold">下一个</strong>，保持所有之前的组件以及之前的两个组件被选中。在以下屏幕中保持其他选项的默认设置，并选择<strong class="bold">部署</strong>。</li>
			</ol>
			<h2 id="_idParaDest-190"><a id="_idTextAnchor194"/>可视化结果</h2>
			<p>现在您已经<a id="_idIndexMarker897"/>设置了车队中心并在边缘部署了代理，您可以使用以下步骤来可视化健康遥测数据:</p>
			<ol>
				<li value="1">导航至<strong class="bold"> AWS 物联网核心控制台</strong>，点击<strong class="bold"> Fleet Hub </strong>，选择您之前在实验室中创建的应用。</li>
				<li>在<strong class="bold">设备列表</strong>部分，点击支持 Greengrass 的 HBS 集线器设备。您将能够查看设备的状态以及各种其他属性，如字段属性、设备影子文件(即设备状态，如果已配置)、设备所属的组以及部署历史(即作业)。</li>
				<li>导航回主屏幕。请随意使用屏幕顶部提供的搜索和过滤选项来优化您的结果。通常，当您有大量网关和相关设备时，这很有用。您还可以翻到<strong class="bold">摘要</strong>部分，按照事物类型、事物组和断开原因来查看设备总数。</li>
				<li>Click on <strong class="bold">Create alarm</strong>. This will help you set up notifications for the following breach:<ol><li>选择一个字段:<strong class="bold">断开原因</strong>。</li><li>选择一个聚合类型:<strong class="bold">计数</strong>。</li><li>选择<strong class="bold">周期</strong>设置为<strong class="bold"> 5 分钟</strong>，然后点击<strong class="bold">下一个</strong>。</li><li>选择<strong class="bold">公制</strong>设置为<strong class="bold">大于/等于 1 </strong>，然后点击<strong class="bold">下一个</strong>。</li><li>假设您只有一个设备网关，如果您有更多设备网关，可以增加数量。</li><li>配置通知和警报详情，然后点击<strong class="bold">下一步并提交</strong>。</li></ol><p>因此，作为设备运营商，您现在可以直观地了解设备设备的运行状况，并在阈值突破时发出警报。</p></li>
				<li>导航到<strong class="bold"> AWS CloudWatch </strong>控制台，点击<strong class="bold">日志</strong>然后选择<strong class="bold">日志组</strong>。</li>
				<li>搜索并点击<code>/aws/events/&lt;replace this with a name of your choice&gt; log group</code>，可视化日志流。</li>
				<li>填充可能需要一些时间，但是日志流应该显示从 Greengrass hub 设备收集的遥测数据。</li>
				<li>您可以随意使用<strong class="bold">日志洞察</strong>，它允许您通过查询界面来分析日志。</li>
			</ol>
			<p>到目前为止，您已经学习了如何使用 AWS 原生解决方案操作一系列支持 Greengrass 的设备。这些模式也适用于非 Greengrass 设备，例如，利用其他设备的 SDK 的设备(如<em class="italic"> AWS 物联网设备 SDK </em>或<em class="italic"> FreeRTOS </em>)。</p>
			<p class="callout-heading">挑战区</p>
			<p class="callout">我想给你一个快速的挑战，以确定如何从 AWS 物联网车队中心向特定的 HBS 中心设备触发 OTA 作业。当您必须推送更新时，例如在<a id="_idIndexMarker898"/>操作事件期间需要的配置文件，这可能是有用的。祝你好运！</p>
			<p>让我们用一个快速总结和一组知识检查问题来结束这一章。</p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor195"/>总结</h1>
			<p>在这一章中，我们向您介绍了设计模式和最佳实践，以及如何管理和维护设备群。这些实践可以帮助您在不同的地理位置供应和操作数百万(或更多)的互联设备。此外，您还学习了如何远程诊断边缘设备的常见问题，或者安全地进行高级故障排除。在此之后，您实现了一个边缘到云的架构，利用了各种 AWS 构建的 components and 服务。这使您可以从 HBS 中心收集健康遥测数据，车队运营商可以通过仪表板直观显示这些数据，通过警报得到通知，或根据需要采取行动。</p>
			<p>在下一章也是最后一章，我们将总结你在整本书中学到的所有关键经验(以及更多)，这样你就可以为现实世界构建架构良好的解决方案了。</p>
			<h1 id="_idParaDest-192"><a id="_idTextAnchor196"/>知识检查</h1>
			<p>在进入下一章之前，通过回答这些问题来测试你的知识。答案可以在书的结尾找到:</p>
			<ol>
				<li value="1">是非判断:设备注册和设备激活是相同的。</li>
				<li>通过 AWS IoT Greengrass 利用 CA 的不同方式有哪些？</li>
				<li>是否有实时配置设备的选项？如果是，那是什么？</li>
				<li>是非判断:指标和日志是监控物联网工作负载所需的唯一数据点。</li>
				<li>您认为为您的整个设备群提供单一控制台视图有什么好处？</li>
				<li>如果需要，无需派遣技术人员，远程故障排除设备的缓解策略是什么？(提示:觉得地道。)</li>
				<li>AWS 物联网 Greengrass 提供哪些组件来收集系统健康遥测？</li>
				<li>是非判断:不可能在边缘设备上聚合指标。它只能在云中完成。</li>
			</ol>
			<h1 id="_idParaDest-193"><a id="_idTextAnchor197"/>参考文献</h1>
			<p>有关本章中讨论的概念的更多信息，请查看以下资源:</p>
			<ul>
				<li>AWS 物联网核心中使用 X.509 证书的<em class="italic">设备制造和供应白皮书</em>:<a href="https://d1.awsstatic.com/whitepapers/device-manufacturing-provisioning.pdf">https://D1 . AWS static . com/whites/Device-Manufacturing-Provisioning . pdf</a></li>
				<li>何时使用 AWS 物联网设备管理:<a href="https://aws.amazon.com/iot-device-management/">https://aws.amazon.com/iot-device-management/</a></li>
				<li>AWS 物联网 Greengrass 发布车队管理功能:<a href="https://aws.amazon.com/about-aws/whats-new/2021/08/aws-iot-greengrass-v-2-4/">https://AWS . Amazon . com/about-AWS/whats-new/2021/08/AWS-IoT-green grass-v-2-4/</a></li>
				<li>AWS 物联网设备管理的车队枢纽:<a href="https://docs.aws.amazon.com/iot/latest/fleethubuserguide/what-is-aws-iot-monitor.html">https://docs . AWS . Amazon . com/IoT/latest/fleethubuserguide/what-is-AWS-IoT-monitor . html</a></li>
				<li>AWS 物联网物联网群组:<a href="https://docs.aws.amazon.com/iot/latest/developerguide/thing-groups.html">https://docs . AWS . Amazon . com/IoT/latest/developer guide/thing-groups . html</a></li>
			</ul>
		</div>
	</div>
</body></html>