<html><head/><body>









<title>Appendix 1: Practicing with Basic GCP Services</title>







<div><div><h1 class="chapter-number" id="_idParaDest-183"><a id="_idTextAnchor184"/>附录 1</h1>

<h1 id="_idParaDest-184"><a id="_idTextAnchor185"/>使用基本 GCP 服务进行练习</h1>

<p>在本附录中，我们将展示一些使用 Google Cloud console 和 Cloud Shell 的 GCP 资源供应示例。我们将使用以下架构来练习使用谷歌云控制台，如图<em class="italic">图 11.1 </em>所示:</p>

<ul>

<li>一个 VPC 网络，VPC1，以及其中的两个子网:一个公有<code>subnet1</code>和一个私有<code>subnet2</code></li>

<li>具有外部 IP 地址并且可以从互联网访问的<code>subnet1</code></li>

<li>私有<code>subnet2</code>中的虚拟机没有外部 IP 地址，因此只能从控制台浏览器或同一 VPC 中的虚拟机进行访问</li>

<li>另一个 VPC 网络 VPC2 和 VPC2 中的一个子网:一个私有<code>subnet8</code></li>

<li>私有虚拟机<code>subnet8</code></li>

<li>VPC1 和 VPC2 之间的对等</li>

</ul>

<div><div><img alt="" height="833" src="img/B18333_11_1.jpg" width="1650"/>

</div>

</div>

<p class="IMG---Caption" lang="en-US" xml:lang="en-US">图 11.1-GCP 控制台实践的示例架构</p>

<p>在<em class="italic">图 11.1 </em>中的 GCP 练习<a id="_idIndexMarker571"/>图中，<code>public subnet1</code>可从互联网上访问。有一个 Google 云存储桶叫做<code>B1</code>。如果我们想让 VM1、VM2 和 VM8 访问<code>B1</code>，我们需要做什么？在进一步阅读之前，这是一个值得思考的问题。</p>

<h1 id="_idParaDest-185"><a id="_idTextAnchor186"/>通过云控制台练习使用 GCP 服务</h1>

<p>在 GCP，项目<a id="_idIndexMarker572"/>是资源提供的基本单位。你可以使用以下步骤开始一个项目:</p>

<ol>

<li value="1">在您从浏览器登录<a id="_idIndexMarker574"/>到 GCP 控制台(<a href="https://console.cloud.google.com">https://console.cloud.google.com</a>)后，您将看到以下开始页面:</li>

</ol>

<div><div><img alt="" height="581" src="img/B18333_11_2.jpg" width="1219"/>

</div>

</div>

<ol>

<li value="2">您可以通过点击<strong class="bold">我的第一个项目</strong>旁边的下拉按钮来创建新项目。</li>

</ol>

<div><div><img alt="" height="57" src="img/B18333_11_3.jpg" width="503"/>

</div>

</div>

<p>在<strong class="bold">我的第一个项目</strong>项目中，我们现在将创建网络 VPC、子网和虚拟机。</p>

<h2 id="_idParaDest-186"><a id="_idTextAnchor187"/>使用 GCP 控制台创建网络 VPC</h2>

<p>使用以下<a id="_idIndexMarker575"/>步骤在 GCP 控制台中创建一个 VPC <a id="_idIndexMarker576"/>:</p>

<ol>

<li value="1">在窗口的左上角，有一个导航下拉菜单，您可以使用它来选择 GCP 服务。</li>

</ol>

<div><div><img alt="" height="620" src="img/B18333_11_4.jpg" width="508"/>

</div>

</div>

<ol>

<li value="2">从左侧的导航菜单中，转到<strong class="bold"> VPC 网络</strong>并从下拉菜单中选择<strong class="bold"> VPC 网络</strong>。它会提示您启用<strong class="bold">计算引擎 API </strong>。继续并启用它。</li>

</ol>

<p>你将被带到<strong class="bold"> VPC 网络</strong>页面，在这里你可以创建一个 VPC 网络。</p>

<ol>

<li value="3">点击<strong class="bold">创建 VPC 网络</strong>。<div> <img alt="" height="281" src="img/B18333_11_5.jpg" width="1078"/> </div></li>

</ol>

<ol>

<li value="4">然后，在网络<a id="_idIndexMarker578"/>细节中填写<a id="_idIndexMarker577"/>并创建 VPC1:<ul><li><code>subnet1</code></li>

<li><code>10.10.1.0/24</code></li>

<li><code>us-east1</code></li>

<li><code>subnet2</code></li>

<li><code>10.10.2.0/24</code></li>

<li><code>asia-east1</code></li>

</ul></li>

</ol>

<p>然后，<code>vpc1</code>创建了两个子网:</p>

<div><div><img alt="" height="106" src="img/B18333_11_6.jpg" width="1181"/>

</div>

</div>

<ol>

<li value="5">重复<em class="italic">步骤 3 </em>和<em class="italic">步骤 4 </em>创建<code>vpc2</code>:<ul><li><code>subnet8</code></li>

<li><code>192.168.1.0/24</code></li>

<li><code>europe-central2</code></li>

</ul></li>

</ol>

<div><div><img alt="" height="191" src="img/B18333_11_7.jpg" width="1229"/>

</div>

</div>

<p>现在<a id="_idIndexMarker579"/>已经创建了两个 VPC<a id="_idIndexMarker580"/>:带有两个子网的<code>vpc1</code>和带有一个子网的<code>vpc2</code>。</p>

<h2 id="_idParaDest-187"><a id="_idTextAnchor188"/>使用 GCP 控制台在 vpc1/subnet1 中创建公共虚拟机 vm1</h2>

<p>使用以下<a id="_idIndexMarker581"/>步骤在 GCP 控制台中创建一个虚拟机<a id="_idIndexMarker582"/>:</p>

<ol>

<li value="1">从左侧的导航菜单，转到<strong class="bold">计算引擎</strong>，然后转到<strong class="bold">虚拟机实例</strong>。点击<strong class="bold">创建实例</strong>按钮。</li>

</ol>

<div><div><img alt="" height="638" src="img/B18333_11_8.jpg" width="963"/>

</div>

</div>

<p>然后，填写虚拟机实例的详细信息:</p>

<ul>

<li><code>vm1</code></li>

<li><code>us-east1</code></li>

<li><code>us-east1-b</code></li>

<li><strong class="bold">机器配置</strong> : <strong class="bold">通用</strong>，<strong class="bold"> N1 </strong>系列</li>

<li><code>f1-micro</code> <strong class="bold"> </strong></li>

<li><code>subnet1</code></li>

</ul>

<p>这在<a id="_idIndexMarker583"/>下面的<a id="_idIndexMarker584"/>截图中显示:</p>

<div><div><img alt="" height="621" src="img/B18333_11_9.jpg" width="1280"/>

</div>

</div>

<ol>

<li value="2">选择其他选项的默认值，然后单击<strong class="bold">网络、磁盘、安全性、管理、单独租赁</strong>。<div> <img alt="" height="559" src="img/B18333_11_10.jpg" width="915"/> </div></li>

</ol>

<ol>

<li value="3">展开<a id="_idIndexMarker585"/>网络选项，然后<a id="_idIndexMarker586"/>转到<strong class="bold">网络接口</strong>。<div> <img alt="" height="603" src="img/B18333_11_11.jpg" width="551"/> </div></li>

</ol>

<ol>

<li value="4">在<code>vpc1</code>中为<a id="_idIndexMarker587"/> <code>subnet1 Ipv4 (10.10.1.0/24)</code>为<strong class="bold">子网</strong>，并将其他一切保留为默认。<div>T57</div></li>

</ol>

<ol>

<li value="5">点击<strong class="bold">完成</strong>和<a id="_idIndexMarker589"/>然后<a id="_idIndexMarker590"/>创建。<div> <img alt="" height="638" src="img/B18333_11_13.jpg" width="459"/> </div></li>

</ol>

<p>在这个<a id="_idIndexMarker591"/>时间，VM1 <a id="_idIndexMarker592"/>在<code>vpc1</code>和<code>subnet1</code> ( <code>10.10.1.0/24</code>创建，内部 IP 地址为<code>10.10.1.2</code>，外部 IP 地址为<code>34.148.1.115</code>。</p>

<div><div><img alt="" height="323" src="img/B18333_11_14.jpg" width="903"/>

</div>

</div>

<p>要允许<strong class="bold">安全 Shell </strong> ( <strong class="bold"> SSH </strong>)进入这个 Linux VM，您需要<a id="_idIndexMarker593"/>创建一个防火墙规则来允许入站 SSH 流量。</p>

<ol>

<li value="6">从<a id="_idIndexMarker594"/>三点下拉菜单<a id="_idIndexMarker595"/>中选择<strong class="bold">查看网络详情</strong>。<div>T80</div></li>

</ol>

<ol>

<li value="7">选择<strong class="bold">防火墙</strong>，然后<strong class="bold">创建防火墙规则</strong>。</li>

</ol>

<div><div><img alt="" height="417" src="img/B18333_11_16.jpg" width="928"/>

</div>

</div>

<ol>

<li value="8">填写防火墙规则详细信息:<ul><li><code>vpc1-firewall-rule2</code></li>

<li><code>vpc1</code></li>

</ul></li>

</ol>

<div><div><img alt="" height="494" src="img/B18333_11_17.jpg" width="889"/>

</div>

</div>

<ol>

<li value="9">选择<code>22</code>的<code>0.0.0.0/0</code>作为端口号<a id="_idIndexMarker597"/>(SSH 使用端口<code>22</code>)。然后，点击<strong class="bold">创建</strong>。</li>

</ol>

<div><div><img alt="" height="687" src="img/B18333_11_18.jpg" width="514"/>

</div>

</div>

<ol>

<li value="10">成功创建防火墙规则<a id="_idIndexMarker598"/>后，返回<a id="_idIndexMarker599"/>到<strong class="bold">虚拟机实例</strong>页面。从<strong class="bold"> SSH </strong>下拉菜单中选择<strong class="bold">在浏览器窗口</strong>中打开(确保允许浏览器弹出窗口)。<div> <img alt="" height="470" src="img/B18333_11_19.jpg" width="901"/> </div></li>

</ol>

<p>现在，您能够 SSH 到 VM 实例。</p>

<div><div><img alt="" height="670" src="img/B18333_11_20.jpg" width="857"/>

</div>

</div>

<p>你<a id="_idIndexMarker600"/>现在有了一个 GCP <a id="_idIndexMarker601"/>虚拟机，名为<code>vm1</code>，创建于<code>vpc1</code>的<code>subnet1</code>中。</p>

<h2 id="_idParaDest-188"><a id="_idTextAnchor189"/>使用 GCP 控制台在 vpc1/subnet2 中创建专用虚拟机 vm2</h2>

<ol>

<li value="1">重复上一节中<em class="italic">的步骤<a id="_idIndexMarker602"/>，在<code>vpc1/subnet2</code>中创建<a id="_idIndexMarker603"/>一个虚拟机。唯一的变化如下:</em><ul><li>选择<code>asia-east1</code>作为<code>subnet2</code>所在的区域。</li>

<li>选择<code>subnet2</code>作为子网。</li>

<li>为<strong class="bold">外部 IPv4 地址</strong>选择<strong class="bold">无</strong>，因为这是一个私有虚拟机，没有分配外部 IP 地址。</li>

</ul></li>

</ol>

<div><div><img alt="" height="614" src="img/B18333_11_21.jpg" width="564"/>

</div>

</div>

<p>现在，<code>vm2</code>在<code>vpc1/subnet2</code>中被<a id="_idIndexMarker604"/>配置了<code>10.10.2.2</code>的 IP 地址<a id="_idIndexMarker605"/>。</p>

<div><div><img alt="" height="430" src="img/B18333_11_22.jpg" width="917"/>

</div>

</div>

<ol>

<li value="2">重复<em class="italic">中的步骤，使用 GCP 控制台</em>在 vpc1/subnet1 内创建一个公共虚拟机 vm1，以创建一个防火墙规则，允许<code>vpc1</code> ( <code>10.10.0.0/16</code>)内的<code>ping</code>，这样<code>vm1</code>和<code>vm2</code>可以相互 ping 通，因为它们在同一个 vpc 中。<div> <img alt="" height="720" src="img/B18333_11_23.jpg" width="676"/> </div></li>

</ol>

<ol>

<li value="3">从<code>vm1</code>平<code>vm2</code> ( <code>10.10.1.2</code>)。</li>

</ol>

<div><div><img alt="" height="206" src="img/B18333_11_24.jpg" width="723"/>

</div>

</div>

<p>这时，你<a id="_idIndexMarker606"/>有了一个 GCP VM，<code>vm2</code>，在<code>vpc1</code>的<code>subnet2</code>中创建了<a id="_idIndexMarker607"/>，<code>vm1</code>可以 ping <code>vm2</code>。</p>

<h2 id="_idParaDest-189"><a id="_idTextAnchor190"/>使用 GCP 控制台在 vpc2/subnet8 内创建一个专用虚拟机 vm8</h2>

<p>使用 GCP 控制台重复<em class="italic">在 vpc1/subnet2 内创建私有虚拟机 vm2 中的步骤<a id="_idIndexMarker608"/>，在<code>vpc2/subnet8</code> ( <code>192.168.1.0/24</code>)中创建<a id="_idIndexMarker609"/>一个没有公共 IP 地址的虚拟机。唯一的变化如下:</em></p>

<ul>

<li>选择<code>europe-central2</code>作为<code>subnet3</code>所在的区域。</li>

<li>选择<code>subnet8</code>作为子网。</li>

</ul>

<p>注意<code>vm1/vm2</code>不能 ping <code>vm8</code>，即使你创建了允许从<code>vpc1</code>ping 到<code>vpc2</code>的防火墙规则，因为在<code>vpc1</code>和<code>vpc2</code>之间没有路由。这就是为什么我们需要在<code>vpc1</code>和<code>vpc2</code>之间创建对等关系。</p>

<h2 id="_idParaDest-190"><a id="_idTextAnchor191"/>使用 GCP 控制台在 vpc1 和 vpc2 之间创建对等关系</h2>

<p>使用以下<a id="_idIndexMarker610"/>步骤在<code>vpc1</code>和<code>vpc2</code>之间创建 VPC 网络对等:</p>

<ol>

<li value="1">从导航菜单中，进入<strong class="bold"> VPC 网络</strong>，然后进入<strong class="bold"> VPC 网络对等</strong>。<div> <img alt="" height="691" src="img/B18333_11_25.jpg" width="466"/> </div></li>

</ol>

<ol>

<li value="2">从<code>vpc1</code>到<code>vpc2</code>创建<code>vpc12-peering</code>。</li>

</ol>

<div><div><img alt="" height="820" src="img/B18333_11_26.jpg" width="865"/>

</div>

</div>

<ol>

<li value="3">对<code>vpc2</code>到<code>vpc1</code>对等做同样的<a id="_idIndexMarker611"/>，这样两个对等现在都将被激活。<div> <img alt="" height="193" src="img/B18333_11_27.jpg" width="823"/> </div></li>

</ol>

<ol>

<li value="4">来自<code>vm1</code>的平<code>vm8</code> ( <code>192.168.1.2</code>)。</li>

</ol>

<div><div><img alt="" height="118" src="img/B18333_11_28.jpg" width="645"/>

</div>

</div>

<p>你现在有了一个 GCP 虚拟机<a id="_idIndexMarker612"/>，在<code>vpc2</code>的<code>subnet8</code>中创建的<code>vm8</code>，并且<code>vm1</code>可以 ping <code>vm8</code>。</p>

<h2 id="_idParaDest-191"><a id="_idTextAnchor192"/>从 GCP 控制台创建 GCS 存储桶</h2>

<p>使用<a id="_idIndexMarker613"/>以下步骤创建<a id="_idIndexMarker614"/>一个 GCS 铲斗:</p>

<ol>

<li value="1">从导航菜单中，转到<strong class="bold">云存储</strong>，然后转到<strong class="bold">存储桶</strong>。</li>

</ol>

<div><div><img alt="" height="598" src="img/B18333_11_29.jpg" width="1214"/>

</div>

</div>

<ol>

<li value="2">在新窗口中，点击<strong class="bold">创建桶</strong>。</li>

</ol>

<div><div><img alt="" height="533" src="img/B18333_11_30.jpg" width="944"/>

</div>

</div>

<ol>

<li value="3">为<a id="_idIndexMarker616"/> GCP 存储桶选择一个全局唯一的<a id="_idIndexMarker615"/>名称。这里我们用<code>bucket-08282022</code>。选择<strong class="bold">下的<strong class="bold">区域</strong>选择存储您数据的位置</strong>，选择<strong class="bold"> us-east1 </strong>作为存储桶区域。点击<strong class="bold">创建</strong>按钮。<div> <img alt="" height="718" src="img/B18333_11_31.jpg" width="866"/> </div></li>

</ol>

<p>它会将您带到 bucket 页面，在这里您可以创建一个子文件夹、上传文件，或者在之前创建的 bucket 下上传一个文件夹。</p>

<div><div><img alt="" height="430" src="img/B18333_11_32.jpg" width="1159"/>

</div>

</div>

<p>到目前为止，我们已经从控制台<a id="_idIndexMarker617"/>配置了 GCP <a id="_idIndexMarker618"/>资源(虚拟专用网络/子网、VPC 对等、虚拟机和存储)。所有这些供应都可以使用云外壳来完成。在下一节中，我们将提供用于 GCP 资源供应的云 Shell 命令/脚本。</p>

<h1 id="_idParaDest-192"><a id="_idTextAnchor193"/>使用谷歌云外壳提供 GCP 资源</h1>

<p>我们<a id="_idIndexMarker619"/>可以使用谷歌云外壳<a id="_idIndexMarker620"/>来供应所有资源，而不是使用 GCP 控制台。在下面的示例中，GCP 架构如图<em class="italic">图 11.2 </em>所示，我们使用云 Shell 命令来配置 GCP 资源，包括网络 VPCs 子网、虚拟机和 VPC 对等。请在云壳中练习使用它们，并确保您理解每个步骤。</p>

<div><div><img alt="" height="617" src="img/B18333_11_33.jpg" width="1232"/>

</div>

</div>

<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> </p>

<p class="IMG---Caption" lang="en-US" xml:lang="en-US">图 11.2–GCP 云外壳实践的示例架构</p>

<ol>

<li value="1">创建<a id="_idIndexMarker621"/>一个项目，VPC 和<a id="_idIndexMarker622"/>子网:<pre>gcloud projects create test10122021 --folder 464105225938 gcloud compute networks create vpc1 --project corvel-032021  --subnet-mode=custom gcloud compute networks subnets create subnet11 --network=vpc1 --range=10.10.1.0/24 --project corvel-032021 --region us-west1 gcloud compute networks subnets create subnet12 --network=vpc1 --range=10.10.2.0/24 --project corvel-032021 --region us-east1 gcloud compute networks create vpc2 --project corvel-032021  --subnet-mode=custom gcloud compute networks subnets create subnet2 --network=vpc2 --range=192.168.1.0/24 --project corvel-032021 --region us-central1 gcloud compute networks create vpc3 --project test10122021  --subnet-mode=custom gcloud compute networks subnets create subnet3 --network=vpc3 --range=172.16.1.0/24 --project test10122021 --region us-central1</pre></li>

<li>创建虚拟机:<pre>gcloud compute instances create myvm11 --project corvel-032021 --machine-type=f1-micro --zone=us-west1-a  --subnet=subnet11 gcloud compute instances create myvm12 --project corvel-032021 --machine-type=f1-micro --network-interface=subnet=subnet12,no-address  --zone=us-east1-b gcloud compute instances create myvm2 --project corvel-032021 --machine-type=f1-micro --network-interface=subnet=subnet2,no-address  --zone=us-central1-b gcloud compute instances create myvm3 --project test10122021 --machine-type=f1-micro --network-interface=subnet=subnet3,no-address --zone=us-central1-b</pre></li>

<li>列出所有虚拟机<a id="_idIndexMarker623"/>并记下它们的 IP <a id="_idIndexMarker624"/>地址:<pre>gcloud compute instances list --project corvel-032021     gcloud compute instances list --project test10122021</pre></li>

<li>打开<code>VPC1</code>的防火墙:<pre>gcloud compute firewall-rules create fw1 --network vpc1 --allow tcp:22,icmp --source-ranges 0.0.0.0/0 --project corvel-032021</pre></li>

<li>从控制台 SSH 到<code>myvm11</code>，您应该能够从<code>vm11</code>ping<code>vm12</code>。</li>

<li>但是我们如何从<code>myvm11</code>ping<a id="_idIndexMarker625"/>到<code>myvm2</code>？您需要<a id="_idIndexMarker626"/>来创建<code>VPC1</code>和<code>VPC2</code>(它们在同一个项目中)之间的 VPC 对等关系:<pre>gcloud compute networks peerings create peer12 --project=corvel-032021  --network=vpc1 --peer-project=corvel-032021 --peer-network=vpc2 gcloud compute networks peerings create peer21 --peer-project=corvel-032021  --network=vpc2 --project=corvel-032021 --peer-network=vpc1 gcloud compute networks peerings list --project=corvel-032021</pre></li>

<li>为<code>vpc2</code> : <pre>gcloud compute firewall-rules create fw2 --network vpc2 --allow tcp:22,icmp --source-ranges 0.0.0.0/0 --project corvel-032021</pre>打开防火墙</li>

<li>现在你应该可以从<code>vm11</code>ping<code>vm2</code>了。但是我们如何从<code>myvm11</code>ping 到<code>myvm3</code>？您需要在<code>vpc1</code>和<code>vpc3</code>(它们在不同的项目中)之间创建 VPC 对等关系:<pre>gcloud compute networks peerings create peer13 --project=corvel-032021  --network=vpc1 --peer-project=test10122021 --peer-network=vpc3 gcloud compute networks peerings create peer31 --project=test10122021 --network=vpc3 --peer-project=corvel-032021 --peer-network=vpc1 gcloud compute networks peerings list --project=corvel-032021</pre></li>

<li>为<code>vpc3</code> : <pre>gcloud compute firewall-rules create fw3 --network vpc3 --allow tcp:22,icmp --source-ranges 10.10.1.0/24 --project test10122021</pre>打开防火墙</li>

</ol>

<p>现在你<a id="_idIndexMarker627"/>应该可以从<code>vm11</code>ping<a id="_idIndexMarker628"/>了。</p>

<h1 id="_idParaDest-193"><a id="_idTextAnchor194"/>总结</h1>

<p>在本附录中，我们提供了从 GCP 控制台供应 GCP 服务/资源的实践示例。我们还展示了如何使用 Google Cloud Shell 创建这些基本资源。</p>

</div>

</div>



</body></html>