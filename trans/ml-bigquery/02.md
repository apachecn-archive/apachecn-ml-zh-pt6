

# 一、Google 云和 BigQuery 简介

采用公共云使公司和用户能够获得创新且经济高效的技术。这在大数据和**人工智能** ( **AI** )领域尤其有价值，在这些领域，新的解决方案正在提供仅在几年前使用内部系统似乎不可能实现的可能性。为了在公司的日常业务中发挥效力，新的人工智能能力需要在不同的角色之间共享，而不是只集中在技术人员身上。大多数云提供商目前正在解决跨不同部门和具有不同技能的员工民主化人工智能的挑战。

在这种背景下， **Google Cloud** 提供了几项服务来加速大量数据的处理，构建**机器学习** ( **ML** )应用，可以做出更好的决策。

在本章中，我们将逐步介绍在接下来的实践活动中有用的主要概念。使用渐进式方法，我们将讨论以下主题:

*   介绍谷歌云平台
*   探索 GCP 的人工智能和人工智能服务
*   BigQuery 简介
*   发现 BigQuery ML
*   了解 BigQuery 定价

# 介绍谷歌云平台

从 1998 年推出谷歌搜索开始，谷歌已经开发了世界上最大最强大的 IT 基础设施之一。今天，这个基础设施被数十亿用户用来使用服务，例如 **Gmail** 、 **YouTube** 、 **Google Photo** 和 **Maps** 。10 年后，2008 年，谷歌决定向商业客户开放其网络和 IT 基础设施，将最初为消费者应用开发的基础设施用于公共服务，并推出**谷歌云平台** ( **GCP** )。

谷歌目前向大型企业和中小型企业提供的 90 多种服务涵盖以下类别:

*   **计算**:用于支持带有虚拟机的工作负载或应用，如 Google Compute Engine，带有 Google Kubernetes 引擎的容器，或 AppEngine 等平台。
*   **存储和数据库**:用于以简单方便的方式存储数据集和对象。一些的例子是谷歌云存储、云 SQL 和 Spanner。
*   **联网**:用于通过**虚拟私有云** ( **VPCs** )、防火墙和完全托管的全球路由器，轻松连接全球各地的不同地点和数据中心。
*   **大数据**:用于以结构化、半结构化或非结构化格式存储和处理大量信息。这些服务包括 Google DataProc，GCP 提供的 Hadoop 服务，以及 BigQuery，这也是本书的重点。
*   **AI 和机器学习**:这个产品区为不同类型的用户提供各种工具，使他们能够在日常业务中利用 AI 和 ML。一些例子是 TensorFlow、AutoML、Vision APIs 和 BigQuery ML，这是本书的重点。
*   **身份、安全和管理工具**:该领域包括防止未经授权的访问、确保安全和监控所有其他云基础设施所需的所有服务。身份访问管理、密钥管理服务、云日志和云审计日志只是这些工具中的一部分。
*   **物联网** ( **IoT** ):用于将植物、车辆或任何其他物体连接到 GCP 基础设施，实现现代物联网用例的开发。这一领域的核心组件是谷歌物联网核心。
*   **API 管理**:通过 REST APIs 向客户和合作伙伴公开服务的工具，提供了充分利用互连优势的能力。在这个支柱中，Google Apigee 是最著名的产品之一，被公认为这个细分市场的领导者。
*   **生产力**:用于提高所有公司的生产力和协作，这些公司希望通过 Google Workplace(以前的 GSuite)的强大工具开始与 Google 合作并接受其业务方式。

## 与 GCP 为伍

刚才提到的所有服务都可以通过四个不同的界面访问:

*   **谷歌云控制台**:GCP 基于网络的用户界面，可从兼容的网络浏览器如谷歌 Chrome、Edge 或 Firefox 轻松访问。对于本书中的动手练习，我们将主要使用谷歌云控制台:

![Figure 1.1 – Screenshot of Google Cloud Console
](img/B16772_01_001.jpg)

图 1.1–谷歌云控制台截图

*   **Google Cloud SDK** :可以安装客户端 SDK，以便通过命令行与 GCP 服务进行交互。通过将任务和操作调度到脚本中来实现自动化是非常有用的。
*   **客户端库**:SDK 还包括一些客户端库，用于使用最常见的编程语言(如 Python、Java 和 Node.js)与 GCP 进行交互
*   **REST API**:在 GCP 上执行的任何任务或操作都可以通过从任何兼容软件中调用特定的 REST API 来执行。

既然我们已经学会了如何与 GCP 互动，让我们来看看 GCP 与其他云提供商有何不同。

## 发现 GCP 的主要竞争优势

GCP 不是市场上唯一的公共云提供商。其他公司也开始了这种业务，例如**亚马逊网络服务**(**AWS**)**微软 Azure** 、 **IBM** 和**甲骨文**。出于这个原因，在我们深入了解本书之前，理解 GCP 与云市场中的其他产品有何不同可能是有价值的。

每个云提供商都有自己的使命、策略、历史和优势。让我们来看看为什么谷歌云可以被认为是不同于所有其他云提供商。

### 安全性

谷歌使用谷歌开发和使用的定制硬件，为其全球数据中心提供端到端的安全模型，应用加密默认启用。谷歌为 GCP 采用的安全最佳实践与那些为运行超过 10 亿用户的应用(如 Gmail 和谷歌地图)而开发的最佳实践相同。

### 全球网络和基础设施

在撰写本文时，谷歌的基础设施在 24 个不同地区、74 个可用区域和 144 个网络边缘位置可用，使客户能够连接到谷歌的网络，并确保在带宽、网络延迟和安全性方面的最佳体验。这个网络允许 GCP 用户在不离开谷歌专有网络的情况下跨不同地区移动数据，最大限度地降低了通过公共互联网发送信息的风险。截至今天，据估计约 40%的互联网流量通过谷歌的专有网络。

在下图中，我们可以看到 GCP 地区在全球的分布情况:

![Figure 1.2 – A map of Google's global availability
](img/B16772_01_002.jpg)

图 1.2–谷歌全球可用性地图

最新版本的地图可以在以下网址看到:[https://cloud.google.com/about/locations](https://cloud.google.com/about/locations)。

### 无服务器和完全托管的方法

谷歌提供许多完全受管理的无服务器服务，让其客户专注于高价值的活动，而不是维护操作。一个很好的例子是 BigQuery，它是无服务器数据仓库，将在本章的下一节介绍。

### 环境可持续性

谷歌数据中心使用的能源 100%来自可再生能源。此外，谷歌承诺到 2030 年成为第一家对其所有业务(如数据中心和校园)实现无碳运营的大公司。

### 普适人工智能

谷歌是人工智能行业的先驱，正在利用人工智能和人工智能来改进其消费产品，如谷歌照片，同时也在提高其数据中心的性能和效率。客户可以通过采用 AutoML 和 BigQuery ML 等 GCP 服务来利用谷歌在人工智能和 ML 方面的所有专业知识。这将是本书的主要焦点。

既然我们已经讨论了 GCP 即服务的一些关键要素，让我们更具体地看看 AI 和 ML。

# 探索 GCP 的人工智能和人工智能服务

在我们深入了解 GCP 的所有人工智能和人工智能工具之前，记住谷歌是一家人工智能公司，并在其许多其他产品中嵌入人工智能和人工智能功能，为其客户提供最佳用户体验，这一点非常重要。简单地看一下谷歌的产品，我们可以很容易地察觉到人工智能如何成为一个企业的关键资产。以下是一些例子:

*   Gmail 智能回复允许用户快速回复电子邮件，根据对话的上下文提供有意义的建议。
*   当我们从一个地方移动到另一个地方时，通过结合不同的数据源，谷歌地图能够精确地预测我们的到达时间。
*   谷歌翻译为一百多种语言提供翻译服务。
*   YouTube 和谷歌 Play 商店能够根据用户偏好推荐最佳视频或最有用的移动应用。
*   Google 相册可以识别照片中的人物、动物和地点，简化了存档和整理照片的工作。

谷歌证明了在我们的业务中利用人工智能和人工智能的能力为我们带来了新的机遇，增加了我们的收入，节省了资金和时间，并为我们的客户提供了更好的体验。

为了更好地了解 GCP 在人工智能和人工智能服务方面的丰富性，需要强调的是，GCP 服务能够满足人工智能模型典型生命周期中出现的所有需求:

1.  数据集的摄取和准备
2.  模型的建立和训练
3.  评估和验证
4.  部署
5.  模型的维护和进一步改进

在下图中，您可以看到整个 AI 和 ML GCP 产品组合:

![Figure 1.3 – GCP AI and ML services represented by their icons
](img/B16772_01_003.jpg)

图 1.3–用图标表示的 GCP 人工智能和 ML 服务

根据客户的需求和技能，上述五个阶段中的每一个都可以完全由用户管理，或者委托给 GCP 的自动化功能。为此，可以将 GCP 提供的人工智能和洗钱服务分为三个子类:

*   **核心平台服务**
*   **人工智能应用**
*   **解决方案**

对于其中的每一个子类别，我们将介绍当前最重要的可用服务以及一些可能从中受益的典型用户。

## 核心平台服务

核心人工智能和人工智能服务是最细粒度的项目，客户可以在 GCP 上使用它们来开发人工智能和人工智能用例。它们为用户提供了最大的控制和灵活性，但自动化程度较低；用户也需要在 ML 方面有更多的专业知识。

### 处理单元(CPU、GPU 和 TPU)

借助传统的基础设施即服务方法，开发人员可以为他们的 Google 计算引擎实例配备强大的处理单元，以加速可能需要很长时间才能运行的 ML 模型的训练阶段，特别是在需要处理复杂的上下文或大量数据的情况下。除了我们的笔记本电脑上可用的中央处理器外，GCP 还提供了 Nvidia 制造的高性能图形处理器，以加速繁重的计算工作。除此之外，还有**张量处理单元** ( **TPUs** )，它们是专门为支持 ML 工作负载和执行矩阵计算而设计的。

### 深度学习虚拟机映像

数据科学家面临的最大挑战之一是快速配置环境以开发他们的 ML 模型。出于这个原因，Google Cloud 提供了预配置的 **Google 计算引擎** ( **GCE** )映像，这些映像可以很容易地通过一组预构建的组件和专用于 ML 的库来提供。

在下面的截图中，你可以看到这些**虚拟机** ( **虚拟机**)是如何出现在 GCP 市场的:

![Figure 1.4 – Deep Learning VM in the GCP marketplace
](img/B16772_01_004.jpg)

图 1.4–GCP 市场中的深度学习虚拟机

**深度学习虚拟机映像**是，也针对 ML 工作负载进行了优化，并且已经预先配置为使用 GPU。当从 GCP 市场提供 GCE 映像时，它已经配置了最常见的 ML 框架和编程语言，如 Python、TensorFlow、scikit-learn 等。这使得数据科学家可以专注于模型的开发，而不是开发环境的供应和配置。

### 张量流

**TensorFlow** 是一个数学、统计和 ML 的开源框架。它由 Google Brain 发布，供 Google 内部使用，然后在 Apache License 2.0 下发布。它仍然是最成功的谷歌产品的核心。该框架本身支持 Python，但也可以用于其他编程语言，如 Java、C++和 Go。它需要 ML 专业知识，但它允许用户在定制和灵活性方面取得很大的成果，以开发最佳的 ML 模型。

### 人工智能平台

**AI 平台**是 GCP 的集成服务，提供无服务器工具来训练、评估、部署和维护 ML 模型。有了这项服务，数据科学家能够只关注他们的代码，简化 ML 开发的所有附带活动，例如供应、维护和可伸缩性。

### 人工智能平台笔记本

AI Platform Notebooks 是一项全面管理的服务，为数据科学家提供一个已经与所有其他 GCP 资源集成和连接的环境。类似于深度学习 VM 镜像， **AI 平台笔记本**实例预配置了最新版本的 AI 和 ML 框架，并允许您开发带有图表和书面解释的 ML 模型。

到目前为止描述的所有服务都需要很好的 ML 知识，以及在用最常见的编程语言手工编码方面的经验。核心平台服务满足了数据科学家和 ML 工程师的需求，他们需要完全控制和灵活使用他们正在构建的解决方案，并且他们已经拥有强大的技术技能。

## 积木

在核心平台服务之上，Google Cloud 提供了预构建的组件，可用于加速新的 ML 用例的开发。这一类别包括以下方面:

### AutoML

与上一节中概述的服务不同， **AutoML** 提供构建 ML 模型的能力，即使你在该领域的专业知识有限。它利用谷歌的 ML 功能，允许用户提供他们的数据来训练谷歌已经开发的算法的定制版本。AutoML 目前提供能力来训练图像( **AutoML 视觉**)、视频( **AutoML 视频智能**)、自由文本( **AutoML 自然语言**)、翻译(AutoML 翻译)和结构化数据( **AutoML 表格**)的模型。当 ML 模型被训练并准备好使用时，它被自动部署并通过 REST 端点可用。

### 预构建的 API

Google Cloud 提供了预先构建的 API，这些 API 在表面下利用了 ML 技术，但已经经过训练并准备好使用。这些 API 通过一个标准 REST 接口公开，该接口可以很容易地将集成到应用中，以处理图像(**视觉 API** )、视频(**视频 API** )、自由文本(**自然语言 API** )、翻译(**翻译 API** )、电子商务数据(**建议 AI** )和对话场景(**语音转文本 API)对于可以使用通用训练数据集的通用应用来说，使用预构建的 ML API 是的最佳选择。**

### 大查询 ML

由于 **BigQuery ML** 将在本章接下来的章节中详细讨论，目前您只需要知道这个组件使用户能够使用 SQL 语言，使用存储在 BigQuery 中的结构化数据和一系列支持的算法来构建 ML 模型。

这里描述的构建块都不需要任何特定的 ML 知识，也不需要任何经过验证的编程语言编程经验。事实上，这些服务是为那些不太熟悉 ML，但想快速、轻松地开始使用它的开发人员或业务分析师准备的。另一方面，具有 ML 专业知识的数据科学家也可以利用构建模块来加速模型的开发，从而缩短解决方案的上市时间。

要查看构造块、其用途及其目标用户的摘要，让我们看一下下表:

![Figure 1.5 – Building blocks summary table
](img/B16772_01_005.jpg)

图 1.5–构造块汇总表

既然我们已经学习了积木的基本知识，让我们来看看 GCP 提供的解决方案。

## 解决方案

遵循增量方法，构建模块和核心平台服务也捆绑在一起，以提供开箱即用的解决方案。这些预先构建的模块可以被公司采用，并立即用于改善他们的业务。本节将介绍这些解决方案。

### 人工智能中心

谷歌云的**人工智能中心**作为人工智能组件的市场。它可以在公共模式中使用，以共享和使用由社区开发的资产，该社区在 GCP 上积极工作，或者它可以在您的公司内部私下使用，以共享 ML 资产。该服务的目标是简化不同用户之间有价值资产的共享，有利于重用和加速新用例的部署。

在下面的截图中，你可以看到 AI Hub 的主页:

![Figure 1.6 – Screenshot of AI Hub on GCP
](img/B16772_01_006.jpg)

图 1.6–GCP 人工智能中心的屏幕截图

既然我们已经了解了 AI Hub 的角色，那么让我们来看看云人才解决方案。

### 云人才解决方案

云人才解决方案基本上是一个针对人力资源办公室的解决方案，它使用人工智能改进了候选人发现和招聘流程。我们不会进一步描述该解决方案，但在本章末尾的*更多资源*部分会有一个链接。

### 人工智能联络中心

**呼叫中心人工智能**是一种解决方案，可用于通过人工智能和自动化驱动的呼叫中心来提高客户体验的有效性。该解决方案基于 Dialogflow 以及文本到语音和语音到文本 API。

### 文件 AI

该解决方案侧重于文档处理，以提取相关信息并简化通常需要手动操作的业务流程。该解决方案能够解析 PDF 文件、图像和手写文本，将这些信息转换为数字结构化格式，使它们可供访问和研究。

从他们的描述中很容易看出，谷歌提供的 AI 解决方案更加面向业务，旨在解决特定的挑战。它们可以被配置和定制，但是基本上是为商业用户服务的。

在继续之前，让我们看一下下表，它总结了本节中解释的概念，并提供了不同人工智能和人工智能服务类别的清晰概述:

![Figure 1.7 – Summary of GCP AI and ML services
](img/B16772_01_007.jpg)

图 1.7-GCP 人工智能和物流服务概述

小费

当您需要开发一个新的用例时，我们建议在尝试重新发明轮子之前使用预先构建的解决方案和构建块。如果一个构建块已经满足了你的用例的所有需求，那么使用它是非常有价值的。这将在开发和维护阶段节省时间和精力。只有当用例非常复杂或者非常特殊，无法用构建块或解决方案解决时，才开始考虑使用核心服务。

正如我们在本节中看到的，GCP 的人工智能和人工智能服务非常广泛。现在，让我们仔细看看这本书的主题:Google BigQuery。

# 引入 BigQuery

Google BigQuery 是一种高度可扩展的、无服务器的分布式数据仓库技术，由 Google 于 2006 年在内部构建，并于 2010 年在 GCP 发布供公众使用。由于其架构，它可以存储数 Pb 的数据，并以高性能和按需扩展来查询它们。由于其无服务器的特性，在 BigQuery 上存储和查询数据的用户不必管理底层基础设施，可以专注于实现带来业务价值的逻辑，从而节省时间和资源。

BigQuery 目前被许多大型企业使用，这些企业利用它来做出数据驱动的决策，包括 Twitter、Home Depot 和 Dow Jones。

## BigQuery 架构

BigQuery 有一个分布式架构，运行在谷歌数据中心的数千个节点上。您的数据集不是存储在唯一的服务器上，而是分块并跨不同区域复制，以保证最高的性能和可用性。

在 BigQuery 中，存储层和计算层是完全分离的。这意味着查询引擎运行在与存储数据的服务器不同的服务器上。这个特性使 BigQuery 在数据量和查询执行方面都具有很好的可伸缩性。这种分离的范式只有在谷歌的 Petabit 网络的帮助下才有可能，该网络利用谷歌在全球范围内的专有光缆，将数据从一台服务器快速转移到另一台服务器。

现在让我们更深入地了解 BigQuery 如何管理存储和计算引擎。

### 存储层

与传统的数据仓库不同，BigQuery 以列格式而不是行格式存储数据。这种方法使您能够做到以下几点:

*   为每列获得更好的压缩比，因为列中的数据通常是同类的，压缩起来更简单。
*   减少要读取的数据量，并为数据仓库用例获得尽可能好的性能，这些用例通常基于表中的少量列和聚合操作，如求和、平均和最大值。

所有数据都存储在 Google 专有的分布式文件系统 Google File System(代号为 Colossus)中。数据的分布使其能够保证更快的 I/O 性能和在出现故障时更好的数据可用性。Google 文件系统基于两种不同的服务器类型:

*   **主服务器:**节点不存储数据，但负责管理每个文件的元数据，例如组成文件的每个块的副本的位置和可用数量。
*   **块服务器:**节点实际存储跨不同服务器复制的文件块。

在下图中，你可以看到谷歌文件系统是如何管理数据的:

![Figure 1.8 – Google File System (Colossus) storage strategy
](img/B16772_01_008.jpg)

图 1.8–谷歌文件系统(巨像)存储策略

现在我们已经了解了 BigQuery 如何处理大量数据，让我们看看计算层如何访问这些数据。

### 计算(查询)层

计算层与存储完全分离，负责接收来自 BigQuery 用户的查询语句，并以最快的方式执行它们。该查询引擎基于 Dremel，这是一项由谷歌开发的技术，然后在 2010 年发表在一篇论文中。该引擎利用多级树架构:

1.  树的根节点接收要执行的查询。
2.  根节点将查询拆分并分发到其他名为 mixers 的中间节点。
3.  混合器节点的任务是在将查询传递给叶节点或其他中间混合器节点之前重写查询。
4.  叶节点负责并行读取 Google 文件系统中的数据块。
5.  当从文件系统中提取出正确的数据块时，叶节点对数据执行计算，并最终将它们转移到其他叶节点。
6.  在计算结束时，每个叶节点产生一个返回给父节点的结果。
7.  当所有结果都返回到根节点时，查询的结果被发送给请求执行的用户或应用。

基于多级树的 BigQuery 查询的执行过程如下图所示:

![Figure 1.9 – The BigQuery engine is a multi-level tree
](img/B16772_01_009.jpg)

图 1.9–big query 引擎是一个多级树

每个节点都提供了许多称为 BigQuery slots 的处理单元来执行查询的业务逻辑。BigQuery 槽可以被视为 Dremel 节点上的虚拟 CPU。根据查询的复杂性和受影响的数据量，BigQuery 会自动管理执行特定查询所需的槽的计算。

## BigQuery 相对于传统数据仓库的优势

现在我们已经了解了 BigQuery 的技术架构，让我们来看看与其他传统的内部数据仓库相比，这种架构如何为使用它成为数据驱动型公司的企业带来好处。

### 无服务器

正如我们在中提到的，BigQuery 有一个无服务器架构，用户不仅不必管理服务器的供应和维护，还不必管理与操作系统和支持数据仓库功能的数据库软件的升级和修补相关的所有维护操作。由于采用了无服务器方法，用户可以轻松地将数据接收到 BigQuery 中并使用它，而无需预先执行容量规划或任何硬件和软件配置。这对于原型设计和支持快速失败的方法尤其重要，这种方法有利于创新和实验的文化。

### 可量测性

不管你需要存储的是兆字节的数据还是千兆字节的数据；BigQuery 可以在数据存储和处理方面为您提供最大的灵活性和可伸缩性。由于其多租户架构，中小型企业可以利用与大型企业相同的创新能力，或者他们可以从小型用例开始，以后根据业务需求进行扩展。传统的数据仓库技术利用相同的服务器进行存储和计算。因此，它们并不特别适合不平衡的用例，例如需要大量数据存储，但不需要高计算性能，反之亦然。正如我们在上一节中看到的，由于其分离的架构，BigQuery 被设计为根据用户的实际需求独立扩展存储和计算能力，从而降低了解决方案的总拥有成本。

### 有效性

得益于其弹性分布式架构，BigQuery 能够提供**服务水平协议**(**SLA**)每月正常运行时间百分比大于 99.99%。这个非常高的可用性标准是 Google 授予的，BigQuery 用户不需要付出任何额外的努力，他们不需要考虑高可用性或灾难恢复策略。

### 演出

BigQuery 引擎能够在几秒钟内查询 TB 级数据，在几分钟内查询 Pb 级数据。这种性能是传统的本地数据仓库很难达到的。更高的性能意味着更快地获得洞察力，以及处理大量数据，如果没有巨大的硬件和软件投资，这些数据通常是无法在内部管理的。为了进一步提高性能，BigQuery 提供了启用 BigQuery BI 引擎的可能性。BigQuery BI Engine 是一个内存分析层，可以在 BigQuery 之上激活，以更快地执行查询，延迟不到一秒。

### 实时

传统的数据仓库是为长批量操作而设计的，通常无法管理实时工作负载。然而，BigQuery 提供了一个特定的接口来实时接收数据，使其可以立即用于分析。这一特性为那些希望加快分析速度并克服数据仓库典型方法(通常涉及处理前一天的业务情况)的公司带来了新的可能性。

### 格式灵活性

BigQuery 在 Google 文件系统中以压缩和优化的格式存储文件，但提供了以数据湖技术中通常使用的各种格式加载数据的选项。用户可以使用 Avro、ORC、CSV 和 JSON 格式将数据加载到 BigQuery 中。

### 创新能力

BigQuery 提供了传统数据仓库中没有的两个 SQL 扩展:

*   **BigQuery GIS** :提供使用 SQL 语句轻松管理地理空间数据的能力，以执行地理计算和操作
*   **BigQuery ML** :允许用户在没有编程经验的情况下，利用 SQL 语言训练、评估和运行 ML 模型，从而加速 ML 创新用例的开发

### 安全性

默认情况下，BigQuery 会自动加密和解密客户的数据，然后将其存储在 Google 文件系统中。BigQuery 还负责管理和轮换加密和解密密钥。为了进一步提高安全性，BigQuery 提供了使用**客户管理的加密密钥** ( **CMEKs** )的选项。在这种情况下，密钥由客户在 Google 云密钥管理系统中直接管理。

通过在 Google **身份访问管理系统** ( **IAM** )中设置正确的角色，可以防止对数据的未授权访问和使用。

### 与其他 GCP 服务的集成

使用 BigQuery 的一大好处是与许多其他 GCP 服务的本机集成:

![Figure 1.10 – BigQuery integration with other GCP services
](img/B16772_01_010.jpg)

图 1.10–big query 与其他 GCP 服务的集成

正如在前面的截图中我们可以看到的，Google BigQuery 可以使用外部表从 **Google Bigtable** 、 **Google Cloud Storage** 、 **Google Cloud SQL** 和 **Google Drive** 中读取数据。这个特性可以简化从其他数据库到 BigQuery 的数据摄取，这也可以使用 ETL/ELT 工具来执行，例如 **Google Dataflow** 和**数据融合**。当数据集存储在 BigQuery 中时，可以从其他 GCP 组件访问它们，例如用于数据处理和准备的 **Google DataProc** 、 **DataPrep** 、用于数据可视化的 **Data Studio** 、 **Looker** 和 **Google Sheets** 。BigQuery 与人工智能平台笔记本集成，使数据科学家和工程师能够轻松地从他们的 Jupyter 环境中访问数据。

总的来说，将数据引入 BigQuery 提供了大量的选项，可以根据用户的需求来使用。

### 丰富的合作伙伴生态系统

除了与其他 GCP 服务的集成，谷歌的合作伙伴还提供了与 BigQuery 的连接器和集成，创建了一个丰富的数据管理生态系统。一些例子包括 Informatica、Tableau、Fivetran、Talend 和 Confluent。

### 公共数据集

如果您想使用 BigQuery 从头开始，您可以利用现有的公共表，这些表可以从 BigQuery 公共数据集程序中获得。该程序包含有趣的数据集，这些数据集来自不同行业和不同国家，涉及不同的主题。我们将在下一章中使用一些例子来训练我们的 ML 模型，包括来自自行车共享服务的交易、纽约市的开放数据和出租车旅行记录。

## 与 BigQuery 交互

有不同的方式与 BigQuery 交互。它们是:

*   Google Cloud Console 中的 BigQuery web UI 是可从 web 浏览器访问的图形用户界面，代表了与 BigQuery 交互的最简单方式。
*   `bq`命令行，安装 Google Cloud SDK 时可用。通过将作业和命令包含在脚本中，它可以用于自动化作业和命令。
*   BigQuery REST APIs。BigQuery 原生提供的 API 层可用于将该服务与其他应用集成。
*   客户端库支持使用最常见的编程语言，如 C#、Go、Java、Node.js、PHP、Python 和 Ruby。
*   JDBC/ODBC 驱动程序由谷歌的合作伙伴 Magnitude Simba Driver 开发，可用于 Windows、macOS 和 Linux 系统。
*   第三方和谷歌的合作伙伴已经为他们的应用开发了 BigQuery 连接器，如用于商业智能的 Tableau、用于数据摄取和集成的 Informatica 和 Talend。

出于我们的目的，我们将看看 Google Cloud Console 中可用的 BigQuery web UI，它将在接下来的章节中使用 BigQuery ML 进行开发。

在下面的截图中，你可以看到 BigQuery UI 是如何出现在 GCP 控制台中的:

![Figure 1.11 – BigQuery web and graphical user interface available in the GCP console
](img/B16772_01_011.jpg)

图 1.11–GCP 控制台中可用的 BigQuery web 和图形用户界面

在左栏中，主要的 BigQuery 特性是可用的，数据集被列出并对用户可见。在这种情况下，只有一个数据集。

屏幕的剩余部分被开发画布占据，结果和成果在底部。我们将在 [*第 2 章*](B16722_02_Final_ASB_ePub.xhtml#_idTextAnchor039) 、*设置您的 GCP 和 BigQuery 环境*中学习如何使用 BigQuery web UI，届时我们将创建一个 GCP 项目并开始使用 BigQuery。

## BigQuery 数据结构

大查询结构，如表、视图和 ML 模型，都组织在数据集中。每个数据集是不同结构的容器，可用于控制对底层数据结构的访问。数据集直接链接到以下内容:

*   一个 GCP 项目，托管数据集本身，通常与存储成本的计费账户相关联
*   在创建时定义的地理位置(区域或多区域),以后不能更改
*   分配给数据集的特定名称，该名称在 GCP 项目中应是唯一的

在下图中，您可以看到一个由项目、数据集、表和 BigQuery ML 模型组成的层次结构示例:

![Figure 1.12 – BigQuery hierarchy: datasets, tables, views, and ML models
](img/B16772_01_012.jpg)

图 1.12–大查询层次结构:数据集、表、视图和 ML 模型

如果设置了适当的权限，位于 GCP 的数据集*项目 A* 也可以被链接到另一个 GCP 项目*项目 B* 的用户查询。在这种情况下，存储成本计入托管数据集结构的*项目 A* ，而计算成本计入与*项目 B* 相关的计费账户。这正是我们在未来章节中使用 BigQuery 公共数据集进行实践练习时将会发生的情况。

小费

请记住，您的查询只能包括位于同一区域的表。在 BigQuery 中，不能查询存储在不同地理位置的表。如果要对位于不同地区的表执行查询，需要通过 Google 云存储将数据导出和导入到同一地区的数据集。

现在我们已经了解了 BigQuery 的主要特征，让我们更具体地关注本书的核心:BigQuery ML。

# 发现 BigQuery ML

开发一个新的 ML 模型可能需要很多努力，并且可能是一项耗时的活动。它通常需要不同的技能，是一项复杂的活动，尤其是在大型企业中。ML 模型的典型旅程可以总结为以下流程:

![Figure 1.13 – An ML model's typical development life cycle
](img/B16772_01_013.jpg)

图 1.13–一个 ML 模型的典型开发生命周期

前两步涉及初步原始数据分析和操作:

1.  在**数据探索和理解**阶段，数据工程师或数据科学家首先查看数据，试图理解数据集中所有列的含义，然后选择新用例要考虑的字段。
2.  在**数据准备**期间，数据工程师过滤、聚集和清理数据集，使其可用并准备好用于随后的训练阶段。

在这两个最初阶段之后，实际的 ML 开发过程开始了:

1.  利用 TensorFlow 等 ML 框架和 Python 等编程语言，数据科学家将参与**设计 ML 模型**步骤，在训练数据集上试验不同的算法。
2.  当选择了正确的 ML 算法时，数据科学家执行 ML 模型的**调整**步骤，应用特征工程技术和超参数调整来获得 ML 模型的更好性能。
3.  当模型准备好时，对评估数据集执行最后的**评估**步骤。这个阶段在不同于训练数据集的新数据集上证明 ML 模型的有效性，并最终导致资产的进一步细化。
4.  在开发过程之后，ML 模型通常在具有可伸缩性和健壮性需求的生产环境中部署和使用。
5.  由于不同的输入数据或者为了应用进一步的改进，ML 模型也最终在后续阶段被更新。

所有这些步骤需要不同的技能，并基于不同利益相关者的协作，例如用于数据探索和理解的业务分析师、用于数据准备的数据工程师、用于开发 ML 模型的数据科学家，以及最终用于使模型在安全、健壮和可扩展的生产环境中可用的 IT 部门。

BigQuery ML 简化并加速了新 ML 模型的整个开发过程，允许您做以下事情:

*   利用 SQL 和您公司的现有技能，设计、训练、评估和服务 ML 模型。
*   自动化大多数通常非常耗时的调优活动，以获得有效的模型。
*   确保您有一个健壮的、可伸缩的、易于使用的 ML 模型，利用我们在本章的 *BigQuery 优于传统数据仓库*一节中已经讨论过的 BigQuery 的所有固有特性。

在下图中，您可以看到使用 BigQuery ML 的 ML 模型的生命周期:

![Figure 1.14 – An ML model's development life cycle with BigQuery ML
](img/B16772_01_014.jpg)

图 1.14–使用 BigQuery ML 的 ML 模型的开发生命周期

现在我们已经学习了 BigQuery ML 的基础知识，让我们看看它可以带来的主要好处。

## BigQuery ML 的好处

在 ML 模型的生命周期中，BigQuery ML 可以带来商业和技术上的好处:

*   业务用户和数据分析师可以从传统的描述和报告方法发展到新的预测方法，以利用他们现有的 SQL 技能做出更好的决策。
*   在模型的调优阶段，技术用户可以从 BigQuery ML 的自动化中受益，使用一个独特的集中式工具可以加速 ML 模型的整个开发过程。
*   开发过程进一步加快，因为构建 ML 模型所需的数据集已经可供正确的用户使用，并且不需要从一个数据存储库移动到另一个数据存储库，这带来了合规性和数据复制风险。
*   IT 部门不需要管理在生产环境中服务和使用 ML 模型的基础设施，因为 BigQuery 无服务器架构本身以可伸缩、安全和健壮的方式支持该模型。

在我们分析了 BigQuery ML 可以带来的好处之后，现在让我们看看支持的 ML 算法是什么。

## BigQuery ML 算法

BigQuery ML 支持的 ML 算法列表正在快速增长。目前，支持以下监督式 ML 技术:

*   **线性回归**:用线性模型预测数值
*   **二元逻辑回归**:用于只有两个不同选项(是或否，1 或 0，真或假)可供选择的分类用例
*   **多类逻辑回归**:用于在多个选项之间进行选择的分类场景
*   **矩阵分解**:用于开发基于过去信息的推荐引擎
*   **时间序列**:利用过去的时间序列数据预测业务 KPI
*   **Boosted 树**:用于带有 XGBoost 的分类和回归用例
*   **AutoML 表**:利用 BigQuery SQL 接口的 AutoML 功能
*   **深度神经网络** ( **DNN** ):用于开发分类或回归场景的张量流模型，避免任何代码行

当训练数据集不包含标记数据时，学习被定义为无监督的。BigQuery ML 目前支持以下内容:

*   **K-means 聚类**:用于数据相似对象(人、事实、事件)的分割

除了列出的内容，BigQuery ML 还允许您使用 SQL 语句导入和使用预先训练好的 TensorFlow 模型。

# 了解 BigQuery 定价

在本节中，将解释 BigQuery 和 BigQuery ML 的定价模型。由于 GCP 服务的价格是不断变化的，我们建议您咨询 https://cloud.google.com/bigquery/pricing 以获取最新信息。

让我们看看 BigQuery 的模型。

## BigQuery 定价

根据这项技术的使用，BigQuery 的定价是可伸缩的。有三个主要的成本驱动因素:

*   **存储**:价格根据 BigQuery 中存储的数据量计算。
*   **计算**:资源用于查询、转换和处理数据或训练、评估和使用 ML 模型。
*   **流式传输**:价格根据通过 BigQuery 流式传输 API 获取的记录数量进行计算。

### 储存；储备

大查询存储成本是根据数据集的未压缩大小计算的。BigQuery 提供了两层存储:

*   **Active** :在过去 90 天内插入或更新的表中存储的所有数据都被认为是活动的。在撰写本文时，活动存储每月每 TB 收费 20.00 美元。
*   **Long-term**: All data stored in tables that have not been modified in the last 90 days is considered long-term storage. At the time of writing, long-term storage is charged at $10.00 per terabyte per month. The change to long-term storage is automatically applied by Google and does not require any action by the BigQuery user.

    小费

    得益于 BigQuery 长期存储，不再需要将存档的数据转移到谷歌云存储来节省资金。您可以以非常低的成本保持数据在线和可访问。

### 计算

BigQuery 计算开销是根据执行的查询所处理的数据量来计算的。计算成本可能因客户选择的型号而异:

*   **按需**:此为默认选项。在这种情况下，用户只需为实际消耗的资源付费。
*   **Flat rate**: This option can be enabled by users or companies that want to have a precise estimation of BigQuery costs and want to keep them stable over time. In this case, a reservation for a specific timeframe is needed and a fixed number of BigQuery slots are assigned to one or multiple GCP projects. As of October 2020, the minimum number of slots that can be reserved is 100 and the minimum time of commitment is 60 seconds. Currently, Google allows you to choose different flat rate options according to the actual requirements. This option can be enabled with a monthly, annual, or flex commitment. The flex option allows you to purchase BigQuery slots for short durations (a minimum of 60 seconds).

    小费

    请记住，存储 BigQuery 公共数据集是免费的:您只需为访问和查询它们付费。出于这个原因，使用 BigQuery 公共数据集可能是在 BigQuery 上执行测试的一种经济高效的方式，只需为计算而不是存储付费。

### 流动

将数据加载到 BigQuery 通常是免费的，除了通过 BigQuery streaming API 发生的摄取过程。截至 2020 年 10 月，通过此接口摄入的每 200 MB 数据将向您收取 0.010 美元的费用。每行被视为最小 1 KB。

小费

如果您的用例不要求您实时接收数据，我们建议您使用批量装载机制将数据接收到 BigQuery 中，这总是免费的。

## BigQuery ML 定价

BigQuery ML 的定价模型类似于 BigQuery 计算成本的定价模型。正如我们在上一节中看到的，客户可以在以下选项中进行选择:

*   按需(现收现付)定价模式
*   统一费率定价模型

如果客户已经选择激活固定数量的 BigQuery 插槽的统一费率模式，那么 BigQuery 插槽也可以用来训练、评估和运行 BigQuery ML 模型。

如果客户使用按需定价模型，有必要将 BigQuery ML 算法分成两个不同的类别:

*   **外部模型**:这个类别包括 boosted trees、DNNs、TensorFlow、AutoML。这些模型是在与 BigQuery 集成的其他 GCP 服务上训练的，并且收费不同。
*   **内部模型**:这个类别包括之前提到的所有直接在 BigQuery 上训练的算法。

在撰写本文时，内部模型的定价基于 ML 生命周期主要阶段(训练、评估和预测)处理的数据量:

![Figure 1.15 – BigQuery ML pricing for internal ML models
](img/B16772_01_015.jpg)

图 1.15–内部 ML 模型的 BigQuery ML 定价

外部模型的定价基于用于模型训练的外部 AI 平台资源的成本加上应用于顶部的额外 BigQuery ML 费用:

![Figure 1.16 – BigQuery ML pricing for external ML models
](img/B16772_01_016.jpg)

图 1.16–外部 ML 模型的 BigQuery ML 定价

在 GCP，价格总是在审查之中，随时可能发生变化。为此，我们建议咨询[https://cloud.google.com/bigquery-ml/pricing](https://cloud.google.com/bigquery-ml/pricing)。

## 自由运营和自由层级

BigQuery 免费提供各种各样的操作，以及免费试验这种技术的免费层。

以下操作在 BigQuery 中总是自由的:

*   加载数据
*   复制数据(除了为复制请求的额外存储)
*   导出数据
*   删除数据集、表、视图、分区或函数
*   任何元数据操作
*   读取元数据表和列
*   创建或替换**用户自定义函数**(**UDF**)

为了鼓励使用 BigQuery 进行试验，每个月用户都可以在特定阈值下利用免费的运营预算，如下表所示:

![Figure 1.17 –  BigQuery ML free tiers
](img/B16772_01_017.jpg)

图 1.17–big query ML 自由层

现在我们已经看到了可以使用的 BigQuery 免费层，让我们来看看定价计算器。

## 定价计算器

如果你想很好地估计使用按需定价的 BigQuery 的成本，你可以使用谷歌云定价计算器:【https://cloud.google.com/products/calculator】T21。以下屏幕截图显示了存储、通过流接收和处理以下数据量的每月成本:

*   未压缩存储卷:10 TB
*   流式插入量:1 GB
*   查询处理的数据:150 TB:

![Figure 1.18 – BigQuery pricing calculator
](img/B16772_01_018.jpg)

图 1.18–big query 价格计算器

您可以使用价格计算器来估算所有其他 GCP 服务的消费，以更好地了解您的 GCP 成本。

# 总结

在第一章中，我们已经初步了解了 GCP 提供了什么，它与其他公共云提供商有何不同，以及谷歌如何基于其无处不在的应用(如 Gmail 和谷歌地图)通过 GCP 为公司提供优质服务。

我们还发现，谷歌在人工智能和人工智能方面的成熟经验，是通过制作谷歌照片等产品开发的，也是 GCP 服务的一部分。每个人工智能和人工智能服务都可以根据用户的技能和背景来处理各种用例以及不同类型的用户。例如，大多数技术用户，如数据科学家，可以利用 TensorFlow 对他们开发的 ML 模型进行极大的灵活性和控制，而商业用户可以使用谷歌的解决方案来解决文档 AI 和联络中心 AI 的特定挑战。中级类由 AI 和 ML 积木组成；这些服务可以加速新的 ML 用例的开发，或者在整个公司推广创新技术的使用。

BigQuery 就是其中的一个构件:它的扩展 BigQueryML 通过利用现有的 SQL 技能支持 ML 模型的开发。BigQuery ML 的使用可以为希望使 ML 民主化的公司带来巨大的好处，通过简化通常需要不同利益相关者、技能和工具参与的最繁重和最耗时的活动，使大部分员工能够参与进来。

在下一章中，我们将创建一个新的 Google Cloud 项目，并首次访问 BigQuery。

# 更多资源

*   **谷歌云产品**:[https://cloud.google.com/products/](https://cloud.google.com/products/)
*   **https://cloud.google.com/docs/overview 概述**:[GCP](https://cloud.google.com/docs/overview)
*   **为什么 GCP 与众不同**:[https://cloud . Google . com/free/docs/what-makes-Google-cloud-platform-different](https://cloud.google.com/free/docs/what-makes-google-cloud-platform-different)
*   **谷歌地区和位置**:[https://cloud.google.com/about/locations](https://cloud.google.com/about/locations)
*   **谷歌的可持续发展计划**:[https://sustainability.google/commitments/](https://sustainability.google/commitments/)
*   【艾枢纽】:[https://aihub.cloud.google.com/?hl=en](https://aihub.cloud.google.com/?hl=en)
*   **云天赋大法**:[https://cloud.google.com/solutions/talent-solution?hl=en](https://cloud.google.com/solutions/talent-solution?hl=en)
*   **BigQuery 技术架构**:**[https://cloud.google.com/files/BigQueryTechnicalWP.pdf](https://cloud.google.com/files/BigQueryTechnicalWP.pdf)**
***   **BigQuery 接口**:[https://cloud . Google . com/big query/docs/interactive-with-big query](https://cloud.google.com/bigquery/docs/interacting-with-bigquery)*   **big query ML**:[https://cloud.google.com/bigquery-ml/docs](https://cloud.google.com/bigquery-ml/docs)**