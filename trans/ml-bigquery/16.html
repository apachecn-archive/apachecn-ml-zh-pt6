<html><head/><body>


	
		<title>B16722_12_Final_ASB_ePub</title>
		
	
	
		<div><h1 id="_idParaDest-172"><em class="italic"> <a id="_idTextAnchor174"/>第十二章</em>:用人工智能笔记本使用BigQuery ML</h1>
			<p>对于数据科学家和机器学习工程师来说，笔记本是一个基本的生产力工具。笔记本允许我们与计算资源进行交互，因为我们可以使用它们来编写和执行代码，可视化结果，并与其他数据科学家共享结果。在将代码部署到生产环境之前，数据工程师、数据科学家和机器学习工程师会进行实验并探索数据。他们利用笔记本电脑，因为它们提供了一个灵活敏捷的开发和测试环境。</p>
			<p>在本章中，我们将了解什么是<strong class="bold">人工智能平台笔记本</strong>，如何提供笔记本环境，以及如何使用它来开发BigQuery ML模型。</p>
			<p>我们将从了解笔记本的基础知识开始，然后开始用<strong class="bold">谷歌云平台</strong> ( <strong class="bold"> GCP </strong>)进行一些实际操作。</p>
			<p>在本章中，我们将讨论以下主题:</p>
			<ul>
				<li>发现人工智能平台笔记本</li>
				<li>在笔记本中实现BigQuery ML模型</li>
			</ul>
			<h1 id="_idParaDest-173"><a id="_idTextAnchor175"/>技术要求</h1>
			<p>本章要求您能够访问web浏览器，并能够利用以下内容:</p>
			<ul>
				<li>访问谷歌云控制台的GCP帐户</li>
				<li>托管BigQuery数据集的GCP项目</li>
			</ul>
			<p>现在我们知道了本章的技术要求，让我们学习如何使用AI平台笔记本开发机器学习模型。</p>
			<p>看看下面的视频，看看代码是如何运行的:<a href="https://bit.ly/2QVZ1oY">https://bit.ly/2QVZ1oY</a></p>
			<h1 id="_idParaDest-174"><a id="_idTextAnchor176"/>发现AI平台笔记本</h1>
			<p>在<a id="_idIndexMarker549"/>这一部分，我们将了解什么是<strong class="bold">人工智能平台笔记本</strong>以及它可以提供的优势。</p>
			<p><strong class="bold"> AI平台笔记本</strong>是一项完全托管的服务，允许数据工程师和数据科学家使用JupyterLab开发环境。这项服务允许我们开发、评估、测试和部署机器学习模型。</p>
			<p><strong class="bold"> JupyterLab </strong>是一个面向数据科学家的<a id="_idIndexMarker550"/>网络工具，由Jupyter项目(【https://jupyter.org/about】T21)开发和维护。该项目的目标是开发开放源码软件和标准，提供跨不同编程语言的独特接口。</p>
			<p>使用带有JupyterLab的AI平台<a id="_idIndexMarker551"/>笔记本可以带来几个优势:</p>
			<ul>
				<li>我们可以使用最重要和最有用的ML库，如TensorFlow、Keras、PyTorch等，轻松设置我们预先配置的机器学习环境。</li>
				<li>我们可以根据需求增加硬件资源的规模，从而利用云的可扩展性。例如，我们可以通过按比例增加RAM或添加<strong class="bold">图形处理单元</strong>(<strong class="bold">GPU</strong>)来提高<a id="_idIndexMarker552"/>笔记本的性能。</li>
				<li>我们被允许从我们的笔记本上访问其他谷歌云服务，而不需要执行任何额外的配置。从AI平台笔记本中，我们可以轻松利用BigQuery、Dataflow和Dataproc。</li>
				<li>我们可以将我们的开发环境与诸如Git这样的代码版本管理应用程序集成在一起。</li>
				<li>We can easily share our notebooks with colleagues or friends, thus making collaboration faster and increasing productivity.<p>在下面的截图中，您可以看到JupyterLab笔记本的web界面:</p></li>
			</ul>
			<div><div><img src="img/B16722_12_001.jpg" alt="Figure 12.1 –JupyterLab's web interface&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.1-JupyterLab的网络界面</p>
			<p>笔记本可以包含描述性内容、代码块和结果。它由一系列可以执行的单元组成。有两种类型的细胞:</p>
			<ul>
				<li><strong class="bold">代码单元</strong>:包含要运行的<a id="_idIndexMarker554"/>可执行代码。它们的执行结果会在代码之后立即显示出来。</li>
				<li><strong class="bold"> Markdown单元格</strong>:包含<a id="_idIndexMarker555"/> HTML代码，用于生成标题、列表和格式化文本。这些单元格通常用于描述代码，使整个笔记本易读易懂。</li>
			</ul>
			<p>让我们进入下一部分！</p>
			<h2 id="_idParaDest-175"><a id="_idTextAnchor177"/> AI平台笔记本定价</h2>
			<p>在本<a id="_idIndexMarker556"/>部分，你将了解人工智能笔记本的价格是如何计算并计入你的谷歌云账户的。</p>
			<p>由于JupyterLab软件是开源的，当你使用人工智能平台笔记本时，你只需为你使用的谷歌云资源付费。</p>
			<p>要开始使用AI平台笔记本电脑，您需要支付以下费用:</p>
			<ul>
				<li><strong class="bold">谷歌计算引擎</strong> ( <strong class="bold"> GCE </strong>)，用于部署开发环境的<a id="_idIndexMarker558"/>虚拟机。GCE根据您拥有的虚拟CPU、内存和磁盘的调配数量收费。</li>
				<li>Any<a id="_idIndexMarker559"/> other service that can be invoked from the notebook, such as BigQuery.<p class="callout-heading">小费</p><p class="callout">当你不用的时候，记得关掉你的电脑主机。如果虚拟机保持活动状态，您将继续为这些资源付费，即使您实际上并没有使用它们。</p></li>
			</ul>
			<p>现在我们已经了解了什么是AI平台笔记本，以及为什么它在您开发机器学习模型时会很有用，在下一节中，我们将了解如何配置我们的第一台笔记本。</p>
			<h2 id="_idParaDest-176"><a id="_idTextAnchor178"/>配置第一台笔记本电脑</h2>
			<p>在这个<a id="_idIndexMarker560"/>部分，我们将设置我们的第一个AI平台笔记本，它将用于训练、评估和测试BigQuery ML模型。</p>
			<p>登录GCP控制台后，我们可以开始配置我们的第一台笔记本电脑。让我们开始吧:</p>
			<ol>
				<li>First, let's browse the console's navigation menu until we find the <strong class="bold">AI Platform (Unified)</strong> item. From the submenu, select <strong class="bold">Notebooks</strong>:<div><img src="img/B16722_12_002.jpg" alt="Figure 12.2 – AI Platform Notebooks in the console's menu&#13;&#10;"/></div><p class="figure-caption">图12.2–控制台菜单中的AI平台笔记本</p></li>
				<li>If this is<a id="_idIndexMarker561"/> the first time that we're accessing this service, we will be asked to enable the API. We can click the blue <strong class="bold">ENABLE</strong> button to start using the service:<div><img src="img/B16722_12_003.jpg" alt="Figure 12.3 – Enabling the Notebooks API&#13;&#10;"/></div><p class="figure-caption">图12.3–启用笔记本API</p></li>
				<li>After a <a id="_idIndexMarker562"/>few minutes, the service will be enabled and ready to use. We'll be redirected to a web page containing the statistics of the API that we've just enabled:<div><img src="img/B16722_12_004.jpg" alt="Figure 12.4 – The statistics of the Notebooks API&#13;&#10;"/></div><p class="figure-caption">图12.4–笔记本API的统计数据</p></li>
				<li>Selecting the <strong class="bold">Notebooks</strong> item from the console's navigation menu once more, we'll access the page dedicated to AI Platform Notebooks. By selecting the blue <strong class="bold">CREATE INSTANCE</strong> button, we'll start configuring the notebook:<div><img src="img/B16722_12_005.jpg" alt="Figure 12.5 – Creating new instances&#13;&#10;"/></div><p class="figure-caption">图12.5–创建新实例</p></li>
				<li>为了创建<a id="_idIndexMarker563"/>一个笔记本实例，我们需要为<strong class="bold">实例名</strong>选择一个<code>bigqueryml-packt-notebook</code>，为<strong class="bold">区域</strong>选择<strong class="bold"> us-west1 </strong>，为<strong class="bold">区域</strong>选择<strong class="bold"> use-west1-a </strong>，为<strong class="bold">操作系统选择<strong class="bold"> Debian 10 </strong>以及为<strong class="bold">环境选择</strong></strong></li>
				<li>Scrolling down the configuration page, select <strong class="bold">n1-standard-2</strong> for <strong class="bold">Machine type</strong>. After that, we can start creating the instance by clicking the blue <strong class="bold">CREATE</strong> button:<div><img src="img/B16722_12_007.jpg" alt="Figure 12.7 – Additional options for creating a notebook instance&#13;&#10;"/></div><p class="figure-caption">图12.7–创建笔记本实例的附加选项</p></li>
				<li>After a<a id="_idIndexMarker565"/> few minutes, the notebook instance will be ready to use. Upon selecting <strong class="bold">OPEN JUPYTERLAB</strong>, the JupyterLab notebook will open a new window containing the development environment:<div><img src="img/B16722_12_008.jpg" alt="Figure 12.8 – The list of notebook instances available in the GCP project&#13;&#10;"/></div><p class="figure-caption">图12.8-GCP项目中可用的笔记本实例列表</p></li>
				<li>In the <a id="_idIndexMarker566"/>web interface of the JupyterLab notebook, we can initialize the first notebook file by selecting <strong class="bold">Python 3</strong> as the notebook type:<div><img src="img/B16722_12_009.jpg" alt="Figure 12.9 – Selecting the runtime engine to use in the notebook&#13;&#10;"/></div><p class="figure-caption">图12.9–选择在笔记本中使用的运行时引擎</p></li>
				<li>做出此选择后，将会创建一个新的笔记本文件，并为我们开发BigQuery ML机器学习模型做好准备:</li>
			</ol>
			<div><div><img src="img/B16722_12_010.jpg" alt="Figure 12.10 – When the notebook is initialized, an empty file is displayed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.10–笔记本初始化时，显示一个空文件</p>
			<p>本节我们<a id="_idIndexMarker568"/>配置了我们的第一台AI平台笔记本。在下一节中，我们将使用它来执行一些代码块，以便创建、评估和测试BigQuery ML机器学习模型。</p>
			<h1 id="_idParaDest-177"><a id="_idTextAnchor179"/>在笔记本电脑中实施BigQuery ML模型</h1>
			<p>在<a id="_idIndexMarker569"/>这一节中，我们将利用<a id="_idIndexMarker570"/>我们在<em class="italic">配置第一个笔记本</em>一节中配置的笔记本实例来运行BigQuery SQL语句并开发BigQuery ML机器学习模型。</p>
			<p>为了学习如何使用笔记本，我们将重用我们在第4章 、<em class="italic">用线性回归预测数值</em>中构建的一些代码块。重要的是要记住，用例的目标是预测纽约市自行车共享服务的每次租赁时间。为了实现这个目标，我们训练了一个简单的线性回归机器学习模型。在这一节中，我们将使用相同的技术；也就是说，我们将把代码嵌入到一个人工智能平台笔记本中。</p>
			<h2 id="_idParaDest-178"><a id="_idTextAnchor180"/>编译人工智能笔记本</h2>
			<p>在<a id="_idIndexMarker571"/>这一节中，我们将使用<strong class="bold"> Code </strong>单元格来嵌入SQL查询，使用<strong class="bold"> Markdown </strong>单元格来创建标题和描述。让我们通过执行以下步骤开始编译我们的笔记本:</p>
			<ol>
				<li value="1">First, let's create a title for our notebook. From the cell type drop-down menu, we can select <strong class="bold">Markdown</strong> and insert the following code block into the first cell of the notebook:<pre># NYC Bike Sharing Linear Regression</pre><p>在下面的屏幕截图中，您可以看到第一个单元是如何配置的:</p><div><img src="img/B16722_12_011.jpg" alt="Figure 12.11 – An example of a Markdown cell&#13;&#10;"/></div><p class="figure-caption">图12.11–降价单元格的示例</p><p>文本前面的<strong class="bold"> # </strong>字符用于标识第一级的标题。</p></li>
				<li>通过点击笔记本菜单中的<strong class="bold"> + </strong>按钮，您将添加一个新的单元格。让我们选择<strong class="bold">降价</strong>作为单元格类型，并插入以下描述笔记本的文本:<pre>The following steps will show you how to train, evaluate and test a linear regression model using BigQuery ML.</pre></li>
				<li>To check whether we've written the previous steps properly, we can use the Run button in the notebook menu. We can run each cell to visualize the result:<div><img src="img/B16722_12_012.jpg" alt="Figure 12.12 – The Run button in the notebook menu&#13;&#10;"/></div><p class="figure-caption">图12.12–笔记本菜单中的运行按钮</p><p>在下面的<a id="_idIndexMarker572"/>截图中，您可以看到执行前两步的结果，其中包含标题和简短描述:</p><div><img src="img/B16722_12_013.jpg" alt="Figure 12.13 – The result of executing the first few cells&#13;&#10;"/></div><p class="figure-caption">图12.13-执行前几个单元格的结果</p></li>
				<li>让我们添加一个副标题来开始模型的数据准备部分。我们将在文本前添加另一个<code>##</code>字符，用于标识第二级标题。可以认为是我们在<em class="italic">第一步</em>写的题目的一个副标题。</li>
				<li>现在，我们准备创建<code>12_notebook</code> BigQuery数据集，它将用于托管我们的BigQuery ML模型。让我们在当前GCP项目的<code>US</code>中创建一个<code>12_notebook</code>数据集。在单元格的末尾，<code>print</code>命令用于显示一条确认消息，表明数据集已经成功创建。</li>
				<li>Now, we can add a new <code>`12_notebook.training_table`</code> table:<pre>%%bigquery
### Creation of the training table ###
CREATE OR REPLACE TABLE `12_notebook.training_table` AS
              SELECT 
                    tripduration/60 tripduration,
                    starttime,
                    stoptime,
                    start_station_id,
                    start_station_name,
                    start_station_latitude,
                    start_station_longitude,
                    end_station_id,
                    end_station_name,
                    end_station_latitude,
                    end_station_longitude,
                    bikeid,
                    usertype,
                    birth_year,
                    gender,
                    customer_plan
              FROM
                    `bigquery-public-data.new_york_citibike.citibike_trips`
              WHERE 
                    (
                        (EXTRACT (YEAR FROM starttime)=2017 AND
                          (EXTRACT (MONTH FROM starttime)&gt;=04 OR EXTRACT (MONTH FROM starttime)&lt;=10))
                        OR (EXTRACT (YEAR FROM starttime)=2018 AND
                          (EXTRACT (MONTH FROM starttime)&gt;=01 OR EXTRACT (MONTH FROM starttime)&lt;=02))
                    )
                    AND (tripduration&gt;=3*60 AND tripduration&lt;=3*60*60)
                    AND  birth_year is not NULL
                    AND birth_year &lt; 2007;</pre><p>关键字<code>%%bigquery</code>允许我们包含包含SQL查询的代码块。通过AI平台笔记本和分析数据库的原生集成，SQL语句将直接在BigQuery上运行。</p><p>创建该表的业务逻辑与我们在第四章<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic"/></a><em class="italic"/>中创建<code>`04_nyc_bike_sharing.training_table`</code>表的业务逻辑相同。</p></li>
				<li>现在让<a id="_idIndexMarker574"/>在<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"> <em class="italic">第四章</em> </a>、<em class="italic">用线性回归预测数值</em>中增加一个<code>`04_nyc_bike_sharing.evaluation_table`</code>表。</li>
				<li>最后再来<a id="_idIndexMarker575"/>在<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"> <em class="italic">第四章</em> </a>，<em class="italic">用线性回归预测数值</em>中再加一个<code>`04_nyc_bike_sharing.prediction_table`</code>表。</li>
				<li>下面加一个小标题开始模型的训练部分。我们将通过插入以下标题来添加一个<strong class="bold">降价</strong>单元格:<pre>## Training the linear regression</pre></li>
				<li>现在，我们准备编写BigQuery ML查询，它将从笔记本中训练我们的机器学习模型。让我们添加一个新的<code>`12_notebook.trip_duration_notebook`</code>机器学习模型，它包含我们在第四章<em class="italic">中使用的<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"> <em class="italic">【用线性回归</em>预测数值】的相同业务逻辑，来训练<code>`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</code>模型。</a></em></li>
				<li>下面加一个小标题开始模型的训练部分。我们将通过插入以下标题来添加一个<strong class="bold"> Markdown </strong>单元格:<pre>## Evaluating the linear regression</pre></li>
				<li>现在，我们准备编写BigQuery ML查询来评估机器学习模型。让我们添加一个新的<code>`12_notebook.trip_duration_notebook`</code>机器学习模型，它包含我们在第四章<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"><em class="italic"/></a><em class="italic">中使用的相同业务逻辑，用线性回归</em>预测数值，来评估<code>`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</code>模型。</li>
				<li>让我们添加一个副标题来开始模型的预测部分。我们将通过插入以下标题来添加一个<strong class="bold">降价</strong>单元格:<pre>## Testing the linear regression</pre></li>
				<li>现在，我们可以包含将用于ML模型的BigQuery ML查询。让我们添加一个新的<code>`12_notebook.trip_duration_notebook`</code>机器学习模型，它包含我们在第4章<em class="italic">中使用的<a href="B16722_04_Final_ASB_ePub.xhtml#_idTextAnchor061"> <em class="italic">相同的业务逻辑，用线性回归</em>预测数值，以使用<code>`04_nyc_bike_sharing.trip_duration_by_stations_and_day`</code>模型。</a></em></li>
				<li>在编译阶段结束时，我们可以使用主菜单中的<strong class="bold">保存笔记本</strong>按钮或使用<strong class="bold">将笔记本另存为… </strong>选项来保存笔记本。</li>
			</ol>
			<p>在本节中，我们使用code单元格和Markdown单元格来编译我们的笔记本。在下一节中，我们将运行我们在笔记本中编写的代码。</p>
			<h2 id="_idParaDest-179"><a id="_idTextAnchor181"/>运行AI笔记本中的代码</h2>
			<p>在这个<a id="_idIndexMarker580"/>部分，我们将运行我们在<em class="italic">编译AI笔记本</em>部分编写的代码。让我们先看看我们准备的笔记本。</p>
			<p>在下面的截图中，我们可以看到我们的AI笔记本，它在描述性单元格和代码单元格之间交替出现:</p>
			<div><div><img src="img/B16722_12_014.jpg" alt="Figure 12.14 – The entire notebook file compiled&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.14-编译的整个笔记本文件</p>
			<p>要运行整个笔记本，我们只需打开窗口顶部的<strong class="bold">运行</strong>菜单，选择<strong class="bold">运行所有单元格</strong>，如以下截图所示:</p>
			<div><div><img src="img/B16722_12_015.jpg" alt="Figure 12.15 – Running all the cells&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.15–运行所有单元</p>
			<p>当<a id="_idIndexMarker582"/>选择<strong class="bold">运行所有单元</strong>时，AI平台<a id="_idIndexMarker583"/>笔记本中的所有单元将被依次执行。</p>
			<p>评估步骤结束时，<code>ML.EVALUATE</code>功能的结果将显示在<em class="italic">评估线性回归</em>部分。</p>
			<p>以下屏幕截图显示了评估阶段返回的值:</p>
			<div><div><img src="img/B16722_12_016.jpg" alt="Figure 12.16 – The values returned by the evaluation function&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.16-评估函数返回的值</p>
			<p>预测步骤结束时，<code>ML.PREDICT</code>功能的结果将显示在<code>Testing the linear regression</code>部分。</p>
			<p>在下面的<a id="_idIndexMarker584"/>截图中，我们<a id="_idIndexMarker585"/>可以看到笔记本末尾显示的结果:</p>
			<div><div><img src="img/B16722_12_017.jpg" alt="Figure 12.17 – The values returned by the PREDICT function&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">图12.17-预测函数返回的值</p>
			<p>如您所见，在执行代码块后，笔记本会在SQL语句后立即显示预测结果。如果我们希望增加BigQuery ML开发步骤的可读性和可理解性，这个特性尤其重要。</p>
			<p>在这一节中，我们学习了如何编译一个人工智能笔记本，以及如何运行所有包含代码块或标题和描述的单元。</p>
			<h1 id="_idParaDest-180"><a id="_idTextAnchor182"/>总结</h1>
			<p>在这一章中，我们学习了什么是人工智能笔记本，以及为什么它们可以在机器学习模型的开发中有用，我们也了解了定价模型。我们发现了Google AI平台笔记本和开源环境JupyterLab之间的关系。</p>
			<p>首先，我们使用Google Cloud Console web界面提供了我们的第一个笔记本实例。然后，我们使用这个新实例来开发一个简单的线性回归模型，同时在笔记本文件中交替使用代码块和描述性单元格。</p>
			<p>最后，我们执行了笔记本中的所有步骤，并直接在其web界面中可视化结果。</p>
			<p>在下一章，我们将学习如何使用BigQuery ML直接从BigQuery调用TensorFlow模型。</p>
			<h1 id="_idParaDest-181"><a id="_idTextAnchor183"/>更多资源</h1>
			<ul>
				<li><strong class="bold">纽约市自行车共享公共数据集</strong>:<a href="https://console.cloud.google.com/marketplace/product/city-of-new-york/nyc-citi-bike ">https://console . cloud . Google . com/market place/product/city-of-new York/NYC-Citi-Bike</a></li>
				<li><strong class="bold"> BigQuery ML创建模型</strong>:<a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create ">https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-create</a></li>
				<li><strong class="bold"> BigQuery ML评估模型</strong>:<a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate ">https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-evaluate</a></li>
				<li><strong class="bold">big query ML PREDICT</strong>:<a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict ">https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-PREDICT</a></li>
				<li><strong class="bold"> BigQuery ML线性回归示例</strong>:<a href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-natality">https://cloud . Google . com/big query-ML/docs/bigqueryml-natality</a></li>
				<li><strong class="bold"> Jupyter笔记本最佳实践</strong>:<a href="https://cloud.google.com/blog/products/ai-machine-learning/best-practices-that-can-improve-the-life-of-any-developer-using-jupyter-notebooks">https://cloud . Google . com/blog/products/ai-machine-learning/best-practices-that-can-improve-the-life-of-any-developer-using-Jupyter-Notebooks</a></li>
				<li><strong class="bold">AI平台中的原型模型</strong>:<a href="https://codelabs.developers.google.com/codelabs/prototyping-caip-notebooks/#0">https://code labs . developers . Google . com/code labs/Prototyping-caip-notebooks/# 0</a></li>
			</ul>
		</div>
	

</body></html>