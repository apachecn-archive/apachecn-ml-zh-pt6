

# *第八章*:利用时间序列进行预测

使用历史数据预测未来趋势是我们可以通过机器学习进行的最有趣的活动之一。

基于历史数据点和时间序列进行预测特别有趣，在不同的行业中非常有用。预测可以帮助我们预测未来，也可以帮助我们识别数据中不符合预期模式的异常。

在这一章中，我们将重点介绍使用 ARIMA 加算法进行时间序列预测。这种技术可用于预测不同领域的数值，如公司的销售额、餐馆的顾客、股票价格和建筑物的耗电量。

为了理解我们如何使用 BigQuery ML 来预测趋势并有效地展示我们的结果，我们将浏览以下主题:

*   介绍业务场景
*   发现时间序列预测
*   探索和理解数据集
*   训练时间序列预测模型
*   评估时间序列预测模型
*   使用时间序列预测模型
*   展示预测

# 技术要求

本章要求您访问网络浏览器，并能够利用以下功能:

*   访问谷歌云控制台的 GCP 帐户
*   托管 BigQuery 数据集的 GCP 项目

现在，我们已经准备好了技术需求，让我们开始分析和开发我们的 BigQuery ML 预测模型。

请看下面的视频，看看代码是如何运行的:【https://bit.ly/2QY0Qlp

# 介绍业务场景

想象一下，你是一名为爱荷华州工作的商业分析师。国家通过收集该地区每家商店的数据来监测酒类和烈酒的零售分布。控制酒类销售对于监控公民健康和检查税收尤为重要。

在下面的截图中，您可以看到一张商店中白酒和烈酒典型货架的图片:

![Figure 8.1 – The shelves in a liquor shop
](img/B16722_08_001.jpg)

图 8.1-酒类商店的货架

对于我们的业务场景，我们可以想象爱荷华州想要利用前几年收集的历史数据来预测 2020 年前 30 天销售的公升数。

您的经理可能会要求您利用数据库中已经收集的时间序列数据来预测该州所有商店销售的公升数。

作为一名业务分析师，您的工作是找到预测销售量的最佳算法，并将结果以图形方式呈现给州长的工作人员。

现在，我们已经解释并理解了问题陈述，让我们来看看我们可以使用历史数据来预测销售的机器学习技术。

# 发现时间序列预测

**时间序列**是以一定时间频率映射的一系列数据点。例如，它可以包含在定期收集的股票价格、特定时间段内每天的销售量，或者由**物联网** ( **IoT** )传感器在一天中测量的温度。

在下图中，您可以看到一个温度传感器在 2020 年前 15 天收集的数据的时间序列图:

![Figure 8.2 – Example of time series generated by a temperature sensor
](img/B16722_08_002.jpg)

图 8.2–温度传感器产生的时间序列示例

**预测**使用时间序列分析包括使用机器学习模型，通过利用已知的过去数据来预测特定措施的未来值。

BigQuery ML 提供了一种特定的机器学习算法，使用时间序列数据来预测数值。该算法被设计和开发来完成以下任务:

*   自动清理和调整训练数据，以克服数据质量问题，例如，丢失或重复的值和峰值。
*   补偿由特定时间段(如假期)引起的变化。
*   使用季节和趋势分解黄土算法分解趋势。
*   从数据中推断季节性。
*   最后，应用**自回归综合移动平均** ( **ARIMA** )模型的趋势建模，利用历史数值预测未来数值。

你可以使用 ARIMA 模型来发现时间序列数据中隐藏的模式，或者预测某个特定指标的未来值。

在本节中，我们学习了时间序列预测的基础知识。现在让我们看一下将用于构建 BigQuery ML 模型的数据集。

# 探索和理解数据集

在开始机器学习模型的开发之前，我们将开始查看数据集及其结构。

让我们首先清楚地了解 BigQuery 公共数据集中的时间序列数据，以便在下一节中构建预测模型。

## 了解数据

在本节中，我们将分析数据的结构，以确定用于机器学习模型创建的字段。

要开始研究数据，我们需要做以下工作:

1.  登录我们的谷歌云控制台，从导航菜单访问 **BigQuery** 用户界面。
2.  在我们在第 2 章 、*设置您的 GCP 和 BigQuery 环境*中创建的项目下创建一个新的数据集。对于这个用例，我们将使用默认选项创建数据集`08_sales_forecasting`。
3.  Open the GCP project `iowa_liquor_sales`.

    如下面的截图所示，BigQuery 公共数据集只包含一个表，该表存放从爱荷华州的酒类商店收集的数据:

    ![Figure 8.3 – The Iowa liquor sales public dataset contains the sales of all the liquor shops in Iowa
    ](img/B16722_08_003.jpg)

    图 8.3-爱荷华州酒类销售公共数据集包含爱荷华州所有酒类商店的销售额

    我们将使用表 **sales** 来构建我们的预测模型。该表包含自 2012 年以来在爱荷华州销售的所有酒类信息。

4.  Let's click on the table name **sales** in the BigQuery navigation menu to access the schema of the table:![Figure 8.4 – The structure of the table lists all the information collected in the table
    ](img/B16722_08_004.jpg)

    图 8.4-表格的结构列出了表格中收集的所有信息

5.  Each field is well described in the **Description** column.

    该表包含列 **date** ，它表示销售的日期。出于我们的目的，我们将尝试预测某一天售出的总公升数。因此，我们可以注意到字段 **volume_sold_liters** 的存在。该数字字段表示每笔交易中售出的酒类数量。

在本节中，我们已经分析了 **sales** 表的元数据，并了解了哪些字段对构建我们的预测模型有意义。接下来，是时候查看实际数据并开始查询了。

## 检查数据质量

在这一部分，我们将应用一些数据质量检查来分析我们的训练数据集的完整性。

让我们开始分析将用于构建 BigQuery ML 模型的表:

1.  In order to identify the timeframe of our dataset, let's extract the minimum and maximum value of the `date` field from the ``bigquery-public-data.iowa_liquor_sales.sales`` table:

    ```
    SELECT min(date), max(date) FROM `bigquery-public-data.iowa_liquor_sales.sales`; 
    ```

    通过执行这条 SQL 语句，我们可以注意到数据从 2012 年到 2020 年 11 月底。

    查询结果显示在下面的屏幕截图中:

    ![Figure 8.5 – The result of the query shows the timeframe of the dataset
    ](img/B16722_08_005.jpg)

    图 8.5-查询结果显示了数据集的时间范围

    出于我们的目的，我们可以将注意力集中在 2018 年和 2019 年发生的销售上，以预测 2020 年的前 30 天。

2.  In the second step, we'll analyze the number of distinct dates that we can find in the chosen timeframe:

    ```
    SELECT COUNT(DISTINCT date)
    FROM
            `bigquery-public-data.iowa_liquor_sales.sales`
    WHERE
            EXTRACT (year from date) = 2019         OR  EXTRACT (year from date) = 2018;
    ```

    字段`date`中可用的查询`COUNT`和`DISTINCT`值。使用表达式`EXTRACT (year from date)`，SQL 语句只考虑发生在`2018`和`2019`的销售额。

    查询的结果是，如下图所示:

![Figure 8.6 – The result of the query shows the distinct dates in the dataset
](img/B16722_08_006.jpg)

图 8.6–查询结果显示了数据集中不同的日期

从结果来看，很明显数据集不包含 2 年中每一天的信息。这可能是由于公共假期和商店关闭导致的丢失值造成的。这不是一个大问题，因为 BigQuery ML 会在训练阶段自动管理丢失的值。

现在，我们已经执行了一些 SQL 查询来更好地理解我们的数据集，让我们专注于创建我们的训练数据集。

## 创建训练数据集

在本节中，我们将创建一个表来存储将在下一节中用于训练预测模型的数据点。在训练模型之前，我们还将使用 Data Studio 对时间序列进行图形化分析。

为了训练我们的模型，我们将创建一个特定的表来存放我们的时间序列的历史数据点:

1.  Let's create a table that contains only two fields. The first one is `date` and the second one is `total_sold_liters`:

    ```
    CREATE OR REPLACE TABLE `08_sales_forecasting.iowa_liquor_sales` AS
    SELECT 
            date,
            SUM(volume_sold_liters) total_sold_liters
    FROM
            `bigquery-public-data.iowa_liquor_sales.sales`
    WHERE
            EXTRACT (year from date) = 2019 OR  EXTRACT (year from date) = 2018
    GROUP BY
            date;
    ```

    该查询在数据集`08_sales_forecasting`中创建表`iowa_liquor_sales`。

    该表包含两个不同的字段:`date`列表示交易发生的时间，第二个字段计算为一天内售出的酒类数量的`SUM`。`total_sold_liters`是根据`GROUP BY date`子句以及`2018`和`2019`年的每一天计算的聚合值。

2.  The second step will be to graphically analyze the data stored in the table `iowa_liquor_sales`.

    如下图所示，从左侧的 BigQuery 导航菜单中，我们选择数据集`08_sales_forecasting`，然后选择表`iowa_liquor_sales`:

    ![Figure 8.7 – The training table iowa_liquor_sales is visible in the BigQuery navigation menu
    ](img/B16722_08_007.jpg)

    图 8.7–在 BigQuery 导航菜单中可以看到训练表 iowa _ liquor _ sales

3.  After that, let's click on **EXPORT** and then **Explore with Data Studio** as presented in the following screenshot:![Figure 8.8 – From BigQuery, it's possible to open Data Studio
    ](img/B16722_08_008.jpg)

    图 8.8–从 BigQuery 中，可以打开 Data Studio

    **Data Studio** 是 Google 提供的免费数据可视化工具，与 BigQuery 原生集成，可轻松用于在报告和图表中绘制数据。

4.  In Data Studio, we can select **Time series chart** as the chart type as shown in the following screenshot:![Figure 8.9 – In Data Studio, it's possible to select Time series chart to visualize the data
    ](img/B16722_08_009.jpg)

    图 8.9–在 Data Studio 中，可以选择时间序列图来可视化数据

5.  Then, we can choose the field **date** for **Dimension** and **total_sold_liters** for **Metric**, as is presented in the following screenshot:![Figure 8.10 – In Data Studio, it's possible to select Dimension and Metric settings to draw the diagram
    ](img/B16722_08_010.jpg)

    图 8.10–在 Data Studio 中，可以选择维度和度量设置来绘制图表

6.  After that, we can move to the **Style** tab and select **Linear interpolation** in the **Missing Data** combo box:![Figure 8.11 – The Linear interpolation option allows to improve the visualization 
    of the diagram in case of missing values
    ](img/B16722_08_011.jpg)

    图 8.11–线性插值选项允许在缺少值的情况下改善图表的可视化

7.  完成这些配置后，我们可以看到 Data Studio 绘制的图表，该图表显示了所选时间段内白酒销售量的趋势线:

![Figure 8.12 – The time series is shown in Data Studio with a blue line on the chart
](img/B16722_08_012.jpg)

图 8.12–时间序列显示在 Data Studio 中，图表上有一条蓝线

现在我们已经创建了一个表格，我们的预测模型将在这个表格上进行训练，并将数据可视化为一个图表，让我们开始创建机器学习模型。

# 训练时间序列预测模型

在本节中，我们将训练big query ML 时间序列预测模型。

让我们开始训练机器学习模型`liquor_forecasting`，执行以下 SQL 语句:

```
CREATE OR REPLACE MODEL `08_sales_forecasting.liquor_forecasting`
OPTIONS
 (model_type = 'ARIMA',
  time_series_timestamp_col = 'date',
  time_series_data_col = 'total_sold_liters',
  auto_arima = TRUE,
  data_frequency = 'AUTO_FREQUENCY'
) AS
SELECT *
FROM
 `08_sales_forecasting.iowa_liquor_sales`; 
```

SQL 语句由以下部分组成:

*   查询的第一行以关键字`CREATE OR REPLACE MODEL`开始，接着是机器学习模型的标识符``08_sales_forecasting.liquor_forecasting``，然后是`OPTIONS`。
*   现在让我们专注于我们用来训练机器学习模型的选项。选择的模型类型是`'ARIMA'`。此选项描述了我们用来为 BigQuery ML 预测模型定型的算法。
*   `time_series_timestamp_col = 'date'`指定用于存放时间序列中数据点的时间的列。
*   下一个选项选择列`total_sold_liters`作为存储每个数据点的值的列，它由子句`time_series_data_col = 'total_sold_liters'`表示。
*   属性`auto_arima`，设置为`TRUE`，允许 BigQuery ML 自动识别模型的参数`p`、`d`和`q`。
*   使用最后一个参数`'AUTO_FREQUENCY'`，BigQuery 自动推断时间序列的频率。在这种情况下，频率是每天。其他选项有`'HOURLY'`、`'DAILY'`、`'WEEKLY'`、`'MONTHLY'`、`'QUARTERLY'`和`'YEARLY'`。
*   SQL 语句的最后一部分由应用于训练表`iowa_liquor_sales`的`SELECT`语句组成。

现在，我们已经训练了基于 ARIMA 算法的时间序列预测模型，让我们看看如何使用 BigQuery ML 语法和 BigQuery UI 来评估它。

# 评估时间序列预测模型

在本节中，我们将评估我们在上一节中训练的机器学习模型的性能。

时间序列模型的评估阶段可以通过使用`ML.EVALUATE` BigQuery ML 函数来执行。

让我们执行以下查询来提取表征 ARIMA 模型的所有评估参数:

```
SELECT *
FROM
 ML.EVALUATE(MODEL `08_sales_forecasting.liquor_forecasting`);
```

查询结果如下图所示:

![Figure 8.13 – The records extracted from the evaluation of the time series forecasting model
](img/B16722_08_013.jpg)

图 8.13-从时间序列预测模型的评估中提取的记录

每行定义了被分类为 **ARIMA(p，d，q)** 模型的每个非季节性 ARIMA 模型。对于每一行，我们可以注意到以下内容:

*   字段 **non_seasonal_p** 代表 ARIMA 模型的参数 **p** 。该行的值是用于预测的自回归项的数量。它表示用于预测时间序列下一个值的观察值的数量。
*   字段 **non_seasonal_d** 代表 ARIMA 模型的参数 **d** 。该行的值指示需要应用一个数据点与前一个数据点之间的差异多少次，以减轻数据集的季节性。
*   **non_seasonal_q** 代表 ARIMA 模型的参数 **q** 。它表示用于计算移动平均值的观察值数量，移动平均值用于预测时间序列的下一个值。
*   **has_drift** 显示漂移常数是否应用于模型。
*   **log_likelihood** 是衡量统计模型对特定数据集的拟合程度的参数。
*   **AIC** 代表**赤池信息准则**。该值用于评估模型的良好度。AIC 值越低通常越好。因此，我们可以认为第一种模式是最好的。
*   **方差**测量数据点与序列平均值的距离。
*   **季节性周期**列表达了我们数据中的季节性模式。在这种情况下，BigQuery ML 在销售时间序列中识别出了每周**和每年**和**的模式。**

现在我们已经展示了时间序列预测模型的性能指标，让我们试着用它来预测 2020 年的前 30 天。

# 使用时间序列预测模型

为了使用我们的 BigQuery ML 模型，我们将使用`ML.FORECAST`函数来指定预测的参数。

该查询将提取由接受以下参数的预测函数生成的所有字段:

*   型号名称``08_sales_forecasting.liquor_forecasting``，前面有关键字`MODEL`。
*   一个`STRUCT`，它包括预测的`horizon`:`30`天和为预测选择的`confidence_level`——在本例中，80%:

    ```
    SELECT   * FROM   ML.FORECAST(MODEL `08_sales_forecasting.liquor_forecasting`,               STRUCT(30 AS horizon, 0.8 AS confidence_level)); 
    ```

查询的执行会生成如下屏幕截图所示的记录:

![Figure 8.14 – The results generated by the forecast function
](img/B16722_08_014.jpg)

图 8.14-预测功能生成的结果

我们可以在*图 8.14* 中注意到，预测是根据字段`confidence_level`中的日期按时间顺序排序的。值 0.8 意味着 80%的预测值应该落入由字段**预测 _ 区间 _ 下限**和**预测 _ 区间 _ 上限**确定的预测区间。

现在我们已经应用了我们的模型，让我们了解如何使用 Data Studio 有效地呈现结果。

# 展示预测

在本节中，我们将使用 Data Studio 创建一个时序图，以便以图形方式呈现预测结果。

使用以下查询，我们可以创建一个包含历史值和预测值的表:

```
CREATE OR REPLACE TABLE `08_sales_forecasting.iowa_liquor_sales_forecast` AS
SELECT
  history_date AS date,
  history_value,
  NULL AS forecast_value,
  NULL AS prediction_interval_lower_bound,
  NULL AS prediction_interval_upper_bound
FROM
  (
    SELECT
      date AS history_date,
      total_sold_liters AS history_value
    FROM
      `08_sales_forecasting.iowa_liquor_sales`
  )
UNION ALL
SELECT
  CAST(forecast_timestamp AS DATE) AS date,
  NULL AS history_value,
  forecast_value,
  prediction_interval_lower_bound,
  prediction_interval_upper_bound
FROM
  ML.FORECAST(MODEL `08_sales_forecasting.liquor_forecasting`,
              STRUCT(30 AS horizon, 0.8 AS confidence_level));
```

SQL 语句的执行会生成表`iowa_liquor_sales_forecast`，该表由以下内容组成:

*   所有的记录都来自训练表`iowa_liquor_sales`，我们已经从中提取了时间序列的`history_date`和`history_value`。我们还添加了一些`NULL`字段来标准化模式，查询的第二部分由`UNION ALL`分隔。
*   由`ML.FORECAST`函数生成的所有预测记录都已经在前面的章节*中使用时间序列预测模型*进行了应用。特别有趣的是，我们不仅提取了`forecast_value`，还提取了由字段`prediction_interval_lower_bound`和`prediction_interval_upper_bound`表示的预测的下限和上限。
*   应用于列`forecast_timestamp`的`CAST`函数的存在对于根据到训练表的模式将数据类型从`TIMESTAMP`改变为`DATE`是必要的。

正如我们已经在*创建训练数据集*一节中所做的那样，我们现在可以执行以下操作:

1.  从 BigQuery 导航菜单中选择我们刚刚创建的`iowa_liquor_sales_forecast`表。
2.  点击**导出**，然后点击**使用 Data Studio** 浏览，以访问报告工具。
3.  从**图表**面板中选择**时序图**。
4.  Drag and drop **history_value**, **forecast_value**, **prediction_interval_lower_bound**, and **prediction_interval_upper_bound** into the **Metric** panel as shown in the following screenshot:![Figure 8.15 – The DATA panel allows us to customize the metrics of the chart
    ](img/B16722_08_015.jpg)

    图 8.15–数据面板允许我们自定义图表的指标

5.  移动到**样式**面板，向下滚动直到我们找到**缺失数据**部分。这里我们选择**线性插补**。
6.  Then, at the top of the screen, we can apply a filter on the **date** column to focus our chart only on the period that goes from the first of **December 2019** until the thirtieth of **January 2020**:![Figure 8.16 – Application of the filter on the date column
    ](img/B16722_08_016.jpg)

    图 8.16–在日期列上应用过滤器

7.  点击**应用**，图表将最终可视化，如下图所示:

![Figure 8.17 – Time series chart in Data Studio
](img/B16722_08_017.jpg)

图 8.17-Data Studio 中的时间序列图

查看图的图例，我们可以看到用不同颜色表示的历史值和预测值。我们还可以注意到， **forecast_value** 线总是包含在预测区间内。

# 总结

在这一章中，我们建立了时间序列预测机器学习模型。在介绍了业务场景之后，我们发现了什么是时间序列预测，特别是用于从历史数据点预测值的 ARIMA 算法。

在深入开发 BigQuery ML 模型之前，我们对爱荷华州收集的与该地区商店的酒类销售相关的数据进行了一些分析。为此，我们介绍了报告工具 Data Studio 的使用，可以通过 BigQuery UI 轻松访问它，并利用它来绘制时间序列图。

然后，我们创建了我们的训练表，它包括历史数据的时间序列，并在其上训练我们的 BigQuery ML 模型。然后，我们通过利用 BigQuery ML SQL 语法来评估时间序列预测模型。

在最后一步中，我们预测了爱荷华州 30 天内销售的酒类数量，并将结果绘制在 Data Studio 仪表板中，该仪表板可以呈现给非技术人员。

在下一章，我们将介绍矩阵分解算法来构建推荐引擎。

# 更多资源

*   **爱荷华州酒类零售公共数据集**:[https://console . cloud . Google . com/market place/product/Iowa-department-of-commerce/Iowa-liquid-Sales](https://console.cloud.google.com/marketplace/product/iowa-department-of-commerce/iowa-liquor-sales)
*   **BigQuery ML 创建模型**:[https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-Create](https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create)
*   **BigQuery ML 评估模型**:[https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-Evaluate](https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate)
*   **BigQuery ML 预测**:[https://cloud . Google . com/big query-ML/docs/reference/standard-SQL/bigqueryml-syntax-Forecast](https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-forecast)
*   **BigQuery ML 时间序列预测示例**:[https://cloud . Google . com/big query-ML/docs/ARIMA-single-Time Series-Forecasting-tutorial](https://cloud.google.com/bigquery-ml/docs/arima-single-timeseries-forecasting-tutorial)